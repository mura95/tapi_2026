# 新規会員登録フロー

## 1. 概要

Firebase Authenticationを使用した新規会員登録。**たっぷハウス**と**たっぷポケット**で登録方法が異なる。

| アプリ | 登録場所 | 認証方法 |
|--------|---------|---------|
| たっぷハウス | Unity内 | メール/パスワード |
| たっぷポケット | OSブラウザ | メール/パスワード + Google |

---

## 2. たっぷハウス 登録フロー

### 2.1 フロー図

```
┌─────────────────────────────────────────────────────────────┐
│              たっぷハウス 新規会員登録フロー                  │
└─────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │ ログイン画面  │
    │ 「新規会員登録」│
    │  ボタン押下   │
    └──────┬───────┘
           ↓
    ┌──────────────┐
    │ 登録画面表示  │
    │ (Unity内)    │
    │              │
    │ ・メールアドレス│
    │ ・パスワード   │
    │ ・パスワード確認│
    │ ・表示名      │
    │ ・ペットの名前 │
    │ ・利用規約同意 │
    └──────┬───────┘
           ↓
    ┌──────────────┐
    │ Firebase Auth │
    │ CreateUser   │
    └──────┬───────┘
           ↓
    ┌──────────────┐
    │ 認証メール送信 │
    └──────┬───────┘
           ↓
    ┌──────────────┐
    │ Firestore    │
    │ ユーザー情報  │
    │ 保存         │
    │ appMode:     │
    │ "TapHouse"   │
    └──────┬───────┘
           ↓
    ┌──────────────┐
    │ 認証待ち画面  │
    │「メールを確認  │
    │ してください」 │
    └──────┬───────┘
           ↓
    ┌──────────────┐
    │ 認証完了検知  │
    └──────┬───────┘
           ↓
    ┌──────────────┐
    │ main.unity   │
    │ へ遷移       │
    └──────────────┘
```

### 2.2 登録画面UI（Unity内）

```
┌─────────────────────────────────────────────────────────────┐
│                      新規会員登録                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ← 戻る                                                    │
│                                                             │
│   メールアドレス *                                          │
│   ┌───────────────────────────────────────────────────────┐ │
│   │ example@email.com                                     │ │
│   └───────────────────────────────────────────────────────┘ │
│                                                             │
│   パスワード * （8文字以上）                                │
│   ┌───────────────────────────────────────────────────────┐ │
│   │ ••••••••                                          👁️  │ │
│   └───────────────────────────────────────────────────────┘ │
│   ■■■■■□□□ パスワード強度: 普通                            │
│                                                             │
│   パスワード（確認） *                                      │
│   ┌───────────────────────────────────────────────────────┐ │
│   │ ••••••••                                          👁️  │ │
│   └───────────────────────────────────────────────────────┘ │
│                                                             │
│   表示名 *                                                  │
│   ┌───────────────────────────────────────────────────────┐ │
│   │ たっちゃん                                            │ │
│   └───────────────────────────────────────────────────────┘ │
│                                                             │
│   ペットの名前                                              │
│   ┌───────────────────────────────────────────────────────┐ │
│   │ ぽち                                                  │ │
│   └───────────────────────────────────────────────────────┘ │
│                                                             │
│   ☑ 利用規約・プライバシーポリシーに同意する               │
│                                                             │
│   ┌───────────────────────────────────────────────────────┐ │
│   │               【 登録する 】                          │ │
│   └───────────────────────────────────────────────────────┘ │
│                                                             │
│   すでにアカウントをお持ちの方は ログイン                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 入力項目

| 項目 | 必須 | バリデーション | 備考 |
|------|:----:|----------------|------|
| メールアドレス | ○ | メール形式、重複チェック | Firebase Authで検証 |
| パスワード | ○ | 8文字以上、強度表示 | SecurePlayerPrefsで暗号化保存 |
| パスワード確認 | ○ | パスワードと一致 | - |
| 表示名 | ○ | 1-20文字 | Firestoreに保存 |
| ペットの名前 | - | 1-20文字 | デフォルト「ぽち」 |
| 利用規約同意 | ○ | チェック必須 | - |

---

## 3. たっぷポケット 登録フロー

たっぷポケットの新規登録は**OSブラウザ**で行う。詳細は [pocket-browser-login.md](./pocket-browser-login.md) を参照。

### 3.1 フロー概要

```
アプリ起動
    ↓
「新規登録」ボタン押下
    ↓
OSブラウザで登録ページを開く
https://taphouse.web.app/register
    ↓
Webで登録（メール or Google）
    ↓
Firestore保存（appMode: "TapPocket"）
    ↓
メール認証（メール登録の場合）
    ↓
Deep Linkでアプリに戻る
    ↓
PocketMain.unity へ遷移
```

---

## 4. Firestoreへのユーザー情報保存

### 4.1 保存データ

```javascript
// users/{userId}
{
    "accountCreatedTime": ServerTimestamp,
    "accountType": "PARENT",
    "displayName": "たっちゃん",
    "email": "example@email.com",
    "fcmToken": "",
    "lastLoginTime": ServerTimestamp,
    "notificationSettings": {
        "adminNotification": true,
        "userNotification": true,
        "watchNotification": true
    },
    "petName": "ぽち",
    "userId": "xxxx",
    "appMode": "TapHouse",  // or "TapPocket"
    "isDonor": false,
    "hasAppliedDevice": false
}
```

### 4.2 appModeの決定

| 登録方法 | appMode |
|---------|---------|
| Unity内登録（たっぷハウス） | `"TapHouse"` |
| ブラウザ登録（たっぷポケット） | `"TapPocket"` |

---

## 5. メール認証

### 5.1 認証待ち画面（Unity内）

```
┌─────────────────────────────────────────────────────────────┐
│                      メール認証                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                         ✉️                                  │
│                                                             │
│              認証メールを送信しました                       │
│                                                             │
│      example@email.com に送信されたメールの                 │
│      リンクをクリックして認証を完了してください             │
│                                                             │
│                     ⏳ 認証待ち中...                        │
│                                                             │
│   ┌───────────────────────────────────────────────────────┐ │
│   │            メールが届かない場合                       │ │
│   │            【 認証メールを再送信 】                   │ │
│   └───────────────────────────────────────────────────────┘ │
│                                                             │
│               【 ログイン画面に戻る 】                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 認証確認（ポーリング）

```csharp
// 擬似コード
private async UniTask WaitForEmailVerification()
{
    while (!await CheckEmailVerifiedAsync())
    {
        await UniTask.Delay(TimeSpan.FromSeconds(3));
    }
    // 認証完了 → メイン画面へ
}
```

---

## 6. エラーハンドリング

| エラーコード | メッセージ | 対応 |
|--------------|------------|------|
| `auth/email-already-in-use` | このメールアドレスは既に登録されています | ログイン画面へ誘導 |
| `auth/invalid-email` | メールアドレスの形式が正しくありません | 入力修正を促す |
| `auth/weak-password` | パスワードは8文字以上で設定してください | 入力修正を促す |
| `auth/network-request-failed` | 通信エラーが発生しました | リトライボタン表示 |

---

## 7. セキュリティ考慮事項

| 項目 | 対応 |
|------|------|
| パスワード強度 | 最低8文字、強度インジケータ表示 |
| 認証メール有効期限 | Firebase標準（24時間） |
| ブルートフォース対策 | Firebase標準のレート制限 |
| パスワード保存 | SecurePlayerPrefsで暗号化 |
