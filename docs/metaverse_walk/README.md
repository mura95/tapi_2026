# メタバース散歩機能 実装ロードマップ

## 最終ゴール

```
メタバース空間で犬と散歩し、他ユーザーと音声会話、
スマホを持って実際に歩くとキャラクターが連動して動く
```

---

## マイルストーン概要

| マイルストーン | 内容 | 外部サービス | 追加コスト |
|---------------|------|-------------|-----------|
| **M0** | 基盤準備 | Asset Store | 無料〜¥4,000 |
| **M1** | シングルプレイヤー散歩（ボタン操作） | なし | ¥0 |
| **M2** | マルチプレイヤー同期 | Photon Fusion 2 | 無料〜¥14,250/月 |
| **M3** | 音声通話 | Photon Voice 2 | 無料〜¥14,250/月 |
| **M4** | 加速度センサー連携 | なし | ¥0 |

---

## M0: 基盤準備

### タスク
| # | タスク | 成果物 |
|---|--------|--------|
| 0.1 | メタバースシーン作成 | `Metaverse.unity` |
| 0.2 | 3Dマップ配置 | 公園風マップ |
| 0.3 | NavMesh設定 | 歩行可能エリア定義 |

### 外部サービス・コスト

| サービス | 用途 | 費用 |
|----------|------|------|
| **Unity Asset Store** | 公園3Dマップ | 無料〜¥4,000 |

**推奨アセット:**
- Low Poly Nature Pack（無料）
- Simple Stylized Nature Pack（約¥2,000）
- Cute Park Pack（約¥3,000）

---

## M1: シングルプレイヤー散歩（ボタン操作）

### タスク
| # | タスク | 成果物 |
|---|--------|--------|
| 1.1 | シーン遷移機能 | `SceneTransitionManager.cs` |
| 1.2 | 移動ボタンUI（前進/右/左） | `MovementButtonUI.cs` |
| 1.3 | 犬の移動制御 | `MetaverseDogController.cs` |
| 1.4 | プレイヤーの追従 | `MetaversePlayerFollower.cs` |
| 1.5 | アイソメトリックカメラ | `MetaverseCamera.cs` |
| 1.6 | 散歩終了UI | `ExitWalkButton.cs` |
| 1.7 | 10時トリガー | `WalkScheduler.cs` |

### 移動操作仕様

```
┌─────────────────────────────────┐
│ [散歩やめる]                    │
│                                 │
│         🐕 犬                   │
│         🧑‍🦳 プレイヤー           │
│                                 │
│      ～ 公園風景 ～             │
│                                 │
│   [←左]  [↑前進]  [右→]        │  ← 画面下部に3ボタン
└─────────────────────────────────┘
```

| ボタン | 動作 |
|--------|------|
| **↑前進** | 犬が前方に進む、プレイヤーが追従 |
| **←左** | 犬が左に曲がる |
| **→右** | 犬が右に曲がる |

### 外部サービス・コスト

**なし（¥0）** - Unity標準機能のみ使用

---

## M2: マルチプレイヤー同期

### タスク
| # | タスク | 成果物 |
|---|--------|--------|
| 2.1 | Photon Fusion 2導入 | パッケージ設定 |
| 2.2 | ルーム接続/切断 | `PhotonNetworkManager.cs` |
| 2.3 | プレイヤー位置同期 | `NetworkPlayerController.cs` |
| 2.4 | 犬の位置同期 | `NetworkDogController.cs` |
| 2.5 | プレイヤー名表示 | `PlayerNameTag.cs` |
| 2.6 | 参加人数表示 | HUD |

### 外部サービス・コスト

| サービス | プラン | CCU | 月額 |
|----------|--------|-----|------|
| **Photon Fusion 2** | Free | 100 | **¥0** |
| | Plus | 500 | ¥14,250 |
| | Pro | 1000 | ¥26,250 |

**課金モデル:** CCU（同時接続数）ベース。接続時間は課金に影響しない。

**無料枠で運用可能な規模:**
- 同時接続100人まで
- 10人ルーム × 10個 = 100人同時散歩OK
- 登録ユーザー1,000〜2,000人程度なら無料枠で十分

---

## M3: 音声通話

### タスク
| # | タスク | 成果物 |
|---|--------|--------|
| 3.1 | Photon Voice 2導入 | パッケージ設定 |
| 3.2 | 基本音声通話 | `VoiceChatManager.cs` |
| 3.3 | 近接音声（距離で音量変化） | `ProximityVoiceController.cs` |
| 3.4 | ミュートボタン | `MuteButtonUI.cs` |
| 3.5 | 音声インジケーター | 話し中アイコン |

### 外部サービス・コスト

| サービス | プラン | CCU | 月額 |
|----------|--------|-----|------|
| **Photon Voice 2** | Free | **20** | **¥0** |
| | 100 CCU | 100 | ¥14,250 |
| | 500 CCU | 500 | ¥30,000 |

**注意:** Voice無料枠は20CCUのみ。音声通話を本格運用する場合は有料プラン必須。

---

## M4: 加速度センサー連携

### タスク
| # | タスク | 成果物 |
|---|--------|--------|
| 4.1 | 加速度センサー取得 | `AccelerometerInput.cs` |
| 4.2 | 歩行検知アルゴリズム | `StepDetector.cs` |
| 4.3 | 歩行→キャラ移動連携 | `WalkMovementController.cs` |
| 4.4 | 方向検知（ジャイロ/コンパス） | `DeviceOrientationInput.cs` |
| 4.5 | 操作モード切替UI | ボタン/センサー選択 |

### 外部サービス・コスト

**なし（¥0）** - Unity標準API使用

```csharp
// Unity標準で取得可能
Vector3 acceleration = Input.acceleration;  // 加速度
Gyroscope gyro = Input.gyro;                // ジャイロ
Input.compass.magneticHeading;              // コンパス
```

---

## コスト試算まとめ

### 開発フェーズ（テスト運用）

| 項目 | 費用 |
|------|------|
| 3Dマップアセット | ¥0〜4,000（1回） |
| Photon Fusion | ¥0（100CCU無料） |
| Photon Voice | ¥0（20CCU無料） |
| **合計** | **¥0〜4,000** |

### 本番運用（規模別）

| 規模 | 想定登録者 | 同時接続 | Fusion | Voice | **月額合計** |
|------|-----------|---------|--------|-------|-------------|
| PoC | 〜100人 | 〜20人 | 無料 | 無料 | **¥0** |
| 小規模 | 〜500人 | 〜50人 | 無料 | ¥14,250 | **¥14,250** |
| 中規模 | 〜2,000人 | 〜100人 | 無料 | ¥14,250 | **¥14,250** |
| 大規模 | 〜10,000人 | 〜500人 | ¥14,250 | ¥30,000 | **¥44,250** |

### 1人あたりコスト

| 規模 | 月額 | 登録者 | **1人あたり/月** |
|------|------|--------|-----------------|
| 小規模 | ¥14,250 | 500人 | ¥29 |
| 中規模 | ¥14,250 | 2,000人 | ¥7 |
| 大規模 | ¥44,250 | 10,000人 | ¥4 |

---

## 実装順序と依存関係

```
M0: 基盤準備
 │
 ↓
M1: シングルプレイヤー散歩（ボタン操作） ←── ここで動作確認
 │
 ↓
M2: マルチプレイヤー同期 ←── M1必須
 │
 ↓
M3: 音声通話 ←── M2必須
 │
 ↓
M4: 加速度センサー連携 ←── 最後に追加（ボタン操作の代替）
```

**実装順序:** M0 → M1 → M2 → M3 → M4

**ポイント:**
- M1で3ボタン操作（前進/左/右）を実装、まず動く状態を作る
- M2でマルチプレイヤー対応、他ユーザーと同じ空間で散歩
- M3で音声会話を追加
- M4は最後、加速度センサーでボタン操作を置き換え/拡張

---

## 実装状況

### M0: 基盤準備 - 完了
- メタバースシーン作成、3Dマップ配置、NavMesh設定

### M1: シングルプレイヤー散歩 - 完了
- 移動ボタンUI（前進/左/右）、犬の移動制御（NavMeshAgent統合）、プレイヤー追従、アイソメトリックカメラ
- シングルプレイヤー用ローカルスポーン実装（`MetaverseManager.SpawnLocalEntities()`）
- 犬の移動速度を3.0f（プレイヤー追従速度と同等）に調整
- WalkSchedulerのUpdate毎フレームチェックを廃止し、DogStateControllerの30秒間隔StateCheckに統合

### M2: マルチプレイヤー同期 - 完了
- Photon Fusion 2によるShared Mode接続
- 自動ルームマッチング（時間バケット+連番方式、最大3名/ルーム）
- NetworkSceneManagerDefault重複防止
- Disconnect再入ガード修正（OnShutdownでフラグリセット）
- スポーン位置NavMeshスナップ（地下スポーン防止）
- リモート犬のNavMeshAgent無効化

### M3: 音声通話 - 未着手
### M4: 加速度センサー連携 - 未着手

---

## 詳細ドキュメント

| ファイル | 内容 |
|----------|------|
| [tappu_metaverse_walk_specification.md](./tappu_metaverse_walk_specification.md) | 完全仕様書 |
| [metaverse_walk_overview.md](./metaverse_walk_overview.md) | 機能概要 |
| [metaverse_walk_trigger.md](./metaverse_walk_trigger.md) | 散歩トリガー仕様 |
| [metaverse_walk_scene.md](./metaverse_walk_scene.md) | シーン設計 |
| [metaverse_walk_network.md](./metaverse_walk_network.md) | マルチプレイヤー仕様 |
| [metaverse_walk_voice.md](./metaverse_walk_voice.md) | 音声通話仕様 |
