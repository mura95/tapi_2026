# Tappu メタバース散歩機能 概要

## 1. 機能概要

Tappuのデジタルセラピー犬に「他のユーザーと一緒に散歩できる」マルチプレイヤー機能を追加する。高齢者の社会的孤立を解消するため、バーチャル空間で犬を連れて散歩し、すれ違った人と音声で会話できる体験を提供する。

---

## 2. 開発フェーズ

### フェーズ分け

| フェーズ | 内容 | 範囲 |
|---------|------|------|
| **フェーズ1 (MVP)** | シングルプレイヤー散歩 | 10時トリガー、3Dマップ、犬追従 |
| **フェーズ2** | マルチプレイヤー | Photon Fusion 2、ルーム管理、同期 |
| **フェーズ3** | 音声通話 | Photon Voice 2、近接音声 |

### フェーズ1（MVP）の範囲

```
1. WalkScheduler
   └── 10時に犬が鳴く
   └── 「散歩に行く」ボタン表示
   └── PetState.walk に遷移

2. Metaverseシーン
   └── 公園風3Dマップ（Asset Store）
   └── アイソメトリックカメラ
   └── プレイヤー移動（タッチ）
   └── 犬の追従（NavMesh）

3. 散歩終了
   └── 「散歩をやめる」ボタン
   └── メインシーンに戻る
   └── PetState.idle に復帰
```

### テスト規模

- 10名ルーム × 1〜3個

---

## 3. ユーザー体験フロー

```
1. 毎日10時頃、犬が「散歩に行きたい」と鳴き出す
      ↓
2. 犬の上に「散歩に行く」ボタンが表示される
      ↓
3. ボタンをタップするとメタバース空間へ移動
      ↓
4. どうぶつの森風の俯瞰視点で、犬と一緒に歩く
      ↓
5. 他のユーザーとすれ違うと、近づくほど声が聞こえる（フェーズ2以降）
      ↓
6. 左上の「散歩をやめる」ボタンで元の画面に戻る
```

---

## 4. 技術スタック

| 要素 | 技術 | 役割 | フェーズ |
|------|------|------|---------|
| ゲームエンジン | Unity 6 | アプリ基盤 | 1 |
| スケジューリング | WalkScheduler (新規) | 10時トリガー | 1 |
| 3Dマップ | Asset Store | 公園風マップ | 1 |
| 移動制御 | NavMeshAgent | 犬の追従 | 1 |
| マルチプレイ同期 | Photon Fusion 2 | 位置・動作の同期 | 2 |
| 音声通話 | Photon Voice 2 | リアルタイム音声通信 | 3 |

### システム構成図（フェーズ2以降）

```
┌─────────────────────────────────────────────────┐
│                  Photon Cloud                    │
│  ┌─────────────────┐  ┌─────────────────┐       │
│  │  Fusion Server  │  │  Voice Server   │       │
│  │  （位置同期）    │  │  （音声通信）    │       │
│  └────────┬────────┘  └────────┬────────┘       │
└───────────┼────────────────────┼────────────────┘
            │                    │
    ┌───────┴───────┐    ┌───────┴───────┐
    ↓               ↓    ↓               ↓
┌────────┐     ┌────────┐          ┌────────┐
│ User A │     │ User B │   ...    │ User J │
│ + 犬   │     │ + 犬   │          │ + 犬   │
└────────┘     └────────┘          └────────┘
    （1つのルームに最大10人まで同時接続）
```

---

## 5. 主要機能

### 5.1 散歩トリガー（フェーズ1）

- 毎日10時になると犬が鳴いて散歩をねだる
- 「散歩に行く」ボタンが犬の上に表示される
- ボタンタップでメタバース空間へシーン遷移

詳細: [metaverse_walk_trigger.md](./metaverse_walk_trigger.md)

### 5.2 メタバースシーン（フェーズ1）

- アイソメトリック（俯瞰）視点
- タッチ操作で犬が先導、プレイヤーが後ろからついていく
- 犬が前を歩き、プレイヤーが自動で追従（NavMesh）
- 「散歩をやめる」ボタンでメインシーンに戻る

詳細: [metaverse_walk_scene.md](./metaverse_walk_scene.md)

### 5.3 マルチプレイヤー同期（フェーズ2）

- 最大10人が同じ空間で散歩できる
- アバター（人）と犬の位置がリアルタイム同期
- 他ユーザーの名前が頭上に表示される

詳細: [metaverse_walk_network.md](./metaverse_walk_network.md)

### 5.4 近接音声通話（フェーズ3）

- 他のユーザーに近づくと声が聞こえる
- 距離に応じて音量が変化（近いほど大きい）
- ミュートボタンで自分の声をON/OFF可能

詳細: [metaverse_walk_voice.md](./metaverse_walk_voice.md)

---

## 6. 画面構成

### メインシーン（既存）

```
┌─────────────────────────────┐
│                             │
│                             │
│         🐕 ← 犬             │
│      「散歩に行く」          │
│         ↑ ボタン            │
│                             │
└─────────────────────────────┘
```

### メタバースシーン（新規）

```
┌─────────────────────────────┐
│ [散歩やめる] [🎤]           │  ← 左上にUI
│                             │
│    🐕🧑‍🦳     🐕🧓            │  ← 犬が前、人が後ろ
│         ＼  ／               │
│          💬                 │  ← 近づくと会話可能（フェーズ3）
│         ／  ＼               │
│    🐕👴        🐕🧑          │
│                             │
│  ～～～ 公園の風景 ～～～     │
└─────────────────────────────┘
    （俯瞰視点・アイソメトリック）
    （犬が先導、プレイヤーが追従）
```

---

## 7. 必要な新規ファイル

### フェーズ1（MVP）

| ファイル | 役割 |
|----------|------|
| `WalkScheduler.cs` | 10時の散歩スケジュール管理 |
| `WalkTriggerUI.cs` | 「散歩に行く」ボタン制御 |
| `MetaverseManager.cs` | メタバースシーン管理 |
| `MetaversePlayerController.cs` | プレイヤー移動制御 |
| `MetaverseDogFollower.cs` | 犬の追従ロジック |
| `MetaverseCamera.cs` | アイソメトリックカメラ |

### フェーズ2（マルチプレイヤー）

| ファイル | 役割 |
|----------|------|
| `PhotonNetworkManager.cs` | Photon接続・ルーム管理 |
| `NetworkPlayer.cs` | ネットワーク同期プレイヤー |
| `NetworkDog.cs` | ネットワーク同期犬 |
| `PlayerNameTag.cs` | プレイヤー名タグUI |

### フェーズ3（音声通話）

| ファイル | 役割 |
|----------|------|
| `VoiceChatManager.cs` | 音声通話管理 |
| `ProximityVoice.cs` | 近接音声制御 |
| `MuteButtonUI.cs` | ミュートボタンUI |

---

## 8. PetState追加

```csharp
public enum PetState
{
    idle,       // 通常状態
    feeding,    // 食事中
    sleeping,   // 夜間睡眠中
    ball,       // ボール遊び中
    snack,      // おやつ中
    napping,    // 昼寝中
    ready,      // UI操作待ち
    moving,     // 移動中
    toy,        // おもちゃ遊び中
    action,     // アクション実行中
    walk,       // 散歩中（メタバース）← 追加
}
```

---

## 9. 料金・コスト

### Photon利用料金（フェーズ2以降）

#### 無料枠（Free Tier）

| サービス | 無料枠 | 制限 |
|---------|-------|------|
| Photon Fusion | 100 CCU | 同時接続100人まで |
| Photon Voice | **20 CCU** | 同時接続20人まで |
| メッセージ/月 | 60GB | 超過時は追加課金 |

**重要:** Voice の20 CCUがボトルネック。音声通話を使う場合、無料枠では20人までしか同時接続できない。

#### 課金モデル（重要）

Photon は **CCU（同時接続数）ベースの課金** であり、**接続時間は課金に影響しない**。

```
┌─────────────────────────────────────────────────────────┐
│                    Photonの課金モデル                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ✓ CCU（Concurrent Users）= 同時接続ピーク数で課金      │
│  ✓ 接続時間は関係なし（1分でも1時間でも同じ）            │
│  ✓ 月間のピークCCUがプラン上限を超えなければOK           │
│                                                         │
│  例: 100 CCUプラン                                      │
│  ├── 10時に80人接続 → OK                               │
│  ├── 11時に50人接続 → OK                               │
│  ├── 10時に120人接続 → NG（超過、新規接続拒否）         │
│  └── 各ユーザーが30分接続しても時間は課金に影響なし      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

| 要素 | 課金への影響 |
|------|------------|
| **同時接続数（CCU）** | 直接影響（プラン上限で判定） |
| **接続時間** | **影響なし** |
| **メッセージ量** | 60GB/月超過で追加課金（$0.10/GB） |
| **帯域幅** | 音声通話で増加しやすい |

#### CCU超過時の挙動

| プラン | CCU超過時 |
|--------|----------|
| Free | 新規接続が拒否される（既存接続は維持） |
| 有料 | バースト課金（追加CCU自動購入）または拒否を選択可 |

#### 有料プラン詳細

| プラン | Fusion CCU | Voice CCU | 月額（USD） | 月額（円換算） |
|--------|-----------|-----------|------------|---------------|
| Free | 100 | 20 | $0 | ¥0 |
| Fusion Plus | 500 | - | $95 | 約¥14,250 |
| Voice 100 | - | 100 | $95 | 約¥14,250 |
| Voice 500 | - | 500 | $200 | 約¥30,000 |
| **Fusion + Voice 100** | 500 | 100 | **$190** | **約¥28,500** |
| **Fusion + Voice 500** | 500 | 500 | **$295** | **約¥44,250** |

※ 1ドル = 150円換算

#### CCU（同時接続数）の考え方

```
CCU = 同じ時間帯に同時にオンラインしているユーザー数

例:
- 登録ユーザー 1,000人
- 10時の散歩時間に参加するのは 5%（50人）
- 実際の同時接続 = 50 CCU

同時接続率の目安:
- 一般的なアプリ: 登録者の 1-5%
- 特定時間帯イベント: 10-20%
```

#### 運用コスト試算

| ユースケース | 想定登録者数 | 想定同時接続 | 必要プラン | 月額コスト | **1人あたり月額** |
|-------------|-------------|-------------|-----------|-----------|-----------------|
| **PoC/テスト** | 〜100人 | 〜20人 | Free | ¥0 | ¥0 |
| **小規模運用** | 〜500人 | 〜50人 | Voice 100 | 約¥14,250 | **約¥29** |
| **中規模運用** | 〜2,000人 | 〜100人 | Fusion + Voice 100 | 約¥28,500 | **約¥14** |
| **本格運用** | 〜10,000人 | 〜500人 | Fusion + Voice 500 | 約¥44,250 | **約¥4** |

※ 1人あたり月額 = 月額コスト ÷ 想定登録者数

#### 1人あたりコストの詳細

| 規模 | 登録者数 | 月額 | 年額 | **1人あたり月額** | **1人あたり年額** |
|------|---------|------|------|-----------------|-----------------|
| 小規模 | 500人 | ¥14,250 | ¥171,000 | **¥29** | **¥342** |
| 中規模 | 2,000人 | ¥28,500 | ¥342,000 | **¥14** | **¥171** |
| 本格 | 10,000人 | ¥44,250 | ¥531,000 | **¥4** | **¥53** |

**ポイント:**
- 規模が大きくなるほど1人あたりコストは大幅に下がる
- 小規模（500人）でも月額約29円/人と低コスト
- 本格運用（10,000人）では月額約4円/人

#### 年間コスト試算

| 規模 | 月額 | 年額 |
|------|------|------|
| 小規模（50 CCU） | ¥14,250 | 約¥171,000 |
| 中規模（100 CCU） | ¥28,500 | 約¥342,000 |
| 本格（500 CCU） | ¥44,250 | 約¥531,000 |

#### コスト最適化のポイント

1. **散歩時間を分散**
   - 10時だけでなく、朝・昼・夕方の複数時間帯を設ける
   - ピークCCUを分散してコスト削減

2. **ルームの最大人数を調整**
   - 10人ルーム × 5個 = 50 CCU
   - 5人ルーム × 10個 = 50 CCU（同じ）

3. **Voice使用を限定**
   - 近接範囲内のみVoice接続
   - 全員常時接続ではなく、近づいた時のみ接続

#### 追加費用

| 項目 | 費用 | 備考 |
|------|------|------|
| 帯域超過（60GB超/月） | $0.10/GB | 音声で増えやすい |
| Enterprise サポート | 要見積 | 24/7サポート |
| オンプレミス | 要見積 | 自社サーバー運用 |

---

## 10. 開発スケジュール

### フェーズ1（MVP）

| タスク | 期間 |
|--------|------|
| WalkScheduler実装 | 1-2日 |
| メタバースシーン作成 | 2-3日 |
| プレイヤー移動・カメラ | 1-2日 |
| 犬追従ロジック | 1-2日 |
| UI統合・調整 | 1-2日 |
| **合計** | **約1週間** |

### フェーズ2（マルチプレイヤー）

| タスク | 期間 |
|--------|------|
| Photon Fusion設定 | 1-2日 |
| ネットワーク同期実装 | 3-5日 |
| ルーム管理・マッチング | 2-3日 |
| **合計** | **約1-1.5週間** |

### フェーズ3（音声通話）

| タスク | 期間 |
|--------|------|
| Photon Voice設定 | 1日 |
| 近接音声実装 | 2-3日 |
| UI調整 | 1日 |
| **合計** | **約3-5日** |

---

## 11. Asset Store推奨アセット

### 公園/自然マップ

- **Low Poly Nature Pack** (無料〜)
- **Simple Stylized Nature Pack**
- **Cute Park Pack**

### 要件

- モバイル対応（軽量）
- NavMesh対応の地形
- アイソメトリック視点に適したスタイル

---

## 12. 期待される効果

### 高齢者ユーザーへの価値

1. **社会的つながりの創出**
   - 毎日決まった時間に他者と交流する機会
   - 声を出して会話することで孤立感を軽減

2. **習慣化による継続利用**
   - 犬が「散歩に行きたい」と促すことで能動的な参加を誘発
   - 毎日の楽しみ・日課になる

3. **低い参加ハードル**
   - 複雑な操作不要（ボタン1つで参加）
   - 「散歩」という馴染みのある行為
   - いつでも離脱可能な安心感

### ビジネス上の価値

1. **差別化要因**
   - LOVOTやaiboにはないマルチプレイヤー機能
   - 「つながり」を提供できるデジタルペット

2. **エンゲージメント向上**
   - DAU（日次アクティブユーザー）の向上
   - 利用時間の増加

3. **将来の拡張性**
   - イベント機能（季節の散歩道など）
   - 家族が一緒に参加できる機能
   - 地域コミュニティとの連携

---

## 13. 技術的な制約・注意点

### 制約事項

- 1ルームあたり最大10人まで
- 音声通話にはマイク許可が必要
- インターネット接続が必須
- モバイル回線では音声品質が低下する可能性

### 高齢者向けの配慮

- 大きなボタン、シンプルなUI
- 音声のみのコミュニケーション（テキスト入力不要）
- 自動マッチング（ルーム選択不要）
- 操作説明のチュートリアル

---

## 14. 今後の拡張案

| 機能 | 概要 | 優先度 |
|------|------|--------|
| 季節イベント | 桜・紅葉など季節の散歩道 | 中 |
| 家族参加 | 家族が別端末から一緒に散歩 | 高 |
| 散歩履歴 | 歩いた距離・会話した人数の記録 | 中 |
| エモート | 手を振る、お辞儀などの簡単なジェスチャー | 低 |
| 複数マップ | 公園、海辺、商店街など | 中 |

---

## 15. 関連ドキュメント

| ファイル | 内容 |
|----------|------|
| [metaverse_walk_trigger.md](./metaverse_walk_trigger.md) | 散歩トリガーシステム仕様 |
| [metaverse_walk_scene.md](./metaverse_walk_scene.md) | メタバースシーン設計 |
| [metaverse_walk_network.md](./metaverse_walk_network.md) | マルチプレイヤー同期仕様 |
| [metaverse_walk_voice.md](./metaverse_walk_voice.md) | 音声通話仕様 |
