# メタバース散歩機能 外注仕様書

**作成日:** 2026-02-19
**対象範囲:** M0〜M2（マルチプレイヤー同期）のプロダクションレベル化
**ステータス:** ドラフト

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [外注スコープ定義](#2-外注スコープ定義)
3. [現状分析と課題一覧](#3-現状分析と課題一覧)
4. [技術要件・制約](#4-技術要件制約)
5. [受入基準（Definition of Done）](#5-受入基準definition-of-done)
6. [テスト要件](#6-テスト要件)
7. [納品物・成果物](#7-納品物成果物)
8. [開発環境セットアップ](#8-開発環境セットアップ)
9. [セキュリティ・機密情報の取り扱い](#9-セキュリティ機密情報の取り扱い)
10. [コミュニケーション・進行管理](#10-コミュニケーション進行管理)
11. [契約・発注上の注意点](#11-契約発注上の注意点)
12. [リスク管理](#12-リスク管理)
13. [外注先選定チェックリスト](#13-外注先選定チェックリスト)

---

## 1. プロジェクト概要

### 1.1 アプリの概要

Unity製バーチャルペットシミュレーション（タップハウス）。高齢者向けのたまごっち風Androidアプリケーションで、3D犬との触れ合い、音声コマンド、Firebaseによるクラウド同期機能を備えています。

### 1.2 メタバース散歩機能とは

毎朝10時に犬が「散歩に行きたい」と促し、メタバース空間（3D公園）に遷移。他のユーザーと同じ空間でそれぞれの犬を連れて散歩できるマルチプレイヤー機能です。

**最終ゴール（全マイルストーン完了時）:**

- メタバース空間で犬と散歩
- 他ユーザーと音声会話（M3: 今回のスコープ外）
- スマホを持って実際に歩くとキャラクター連動（M4: 今回のスコープ外）

### 1.3 ターゲットユーザー

**高齢者（65歳以上が中心）** - これは通常のゲーム開発と根本的に異なる制約です：

- エラーメッセージは平易な日本語（専門用語禁止）
- 自動リカバリが必須（「再接続ボタンを押してください」では対応できない）
- ボタンは最小60x60px、フォントは最小20px
- 操作は極力シンプル（シングルタップのみ）

---

## 2. 外注スコープ定義

### 2.1 対象範囲

| 項目                       | 含む/含まない | 備考                         |
| -------------------------- | :-----------: | ---------------------------- |
| M0-M2の既存実装のバグ修正  |   **含む**    |                              |
| M2のプロダクション品質化   |   **含む**    | 本外注の主目的               |
| ネットワーク位置同期の実装 |   **含む**    | 現在未実装の重要課題         |
| エラーハンドリング強化     |   **含む**    | 再接続・バックグラウンド復帰 |
| テストコード作成           |   **含む**    | Unit Test + 結合テスト       |
| M3: 音声通話機能           | **含まない**  | 別フェーズで発注予定         |
| M4: 加速度センサー連携     | **含まない**  | 別フェーズで発注予定         |
| 新規3Dマップ・アセット制作 | **含まない**  | 既存マップを使用             |
| アバターカスタマイズ       | **含まない**  |                              |

### 2.2 具体的な作業項目

以下に優先度順で列挙します。詳細は [3. 現状分析と課題一覧](#3-現状分析と課題一覧) を参照。

#### Priority 1: ブロッカー（必須）

| #    | 作業項目                   | 概要                                                                             | 推定工数             |
| ---- | -------------------------- | -------------------------------------------------------------------------------- | -------------------- |
| P1-1 | ネットワーク位置同期の実装 | 現在アニメーションパラメータのみ同期。プレイヤー/犬のTransformが同期されていない | 2-3日                |
| P1-2 | MAX_PLAYERS_PER_ROOM修正   | 定数が3になっているが仕様は10                                                    | 数時間（テスト含む） |
| P1-3 | バックグラウンド復帰処理   | OnApplicationPause未実装。アプリバックグラウンド→復帰で切断される                | 2-3日                |
| P1-4 | 再接続ロジック強化         | 既存ルームへのRejoin、指数バックオフ、復帰UI                                     | 2-3日                |

#### Priority 2: 重要

| #    | 作業項目                 | 概要                                                               | 推定工数 |
| ---- | ------------------------ | ------------------------------------------------------------------ | -------- |
| P2-1 | エラーダイアログ体系化   | 仕様書E001-E006のエラーコード別に適切なUI表示とリカバリ            | 2-3日    |
| P2-2 | 接続タイムアウト処理     | 30秒タイムアウトの実装。MetaverseManager初期化に無限ハングの可能性 | 1日      |
| P2-3 | シーン遷移のフェード演出 | 現在は遅延のみ。フェードアウト/フェードインの実装                  | 1日      |
| P2-4 | セキュリティ基本対策     | プレイヤー名の長さバリデーション、接続時のタイムスタンプ検証       | 1-2日    |

#### Priority 3: 品質向上

| #    | 作業項目                   | 概要                                                           | 推定工数 |
| ---- | -------------------------- | -------------------------------------------------------------- | -------- |
| P3-1 | 単体テスト作成             | NetworkManager、PlayerController、DogController、WalkScheduler | 3-5日    |
| P3-2 | 結合テスト作成             | 2人接続、入退室、シーン遷移の自動テスト                        | 2-3日    |
| P3-3 | パフォーマンスモニタリング | FPS、レイテンシ、帯域使用量の計測・ログ出力                    | 2日      |
| P3-4 | メモリリーク調査・修正     | NetworkSpawnManagerのFindFirstObjectByType等の最適化           | 1-2日    |

**推定合計工数: 約3-4週間（1人月弱）**

### 2.3 スコープ外の明示（重要）

以下は**今回のスコープに含めない**ことを明確にします。スコープクリープを防ぐために重要です：

- 音声通話機能（Photon Voice 2）の実装
- ミュートボタン/音声インジケーターUI（音声機能に付随するため）
- バーチャルジョイスティックへの変更（現在のボタン操作を維持）
- マップの追加・変更
- 犬のアニメーション追加
- Firebaseとの連携強化
- 他プラットフォーム（iOS）対応

---

## 3. 現状分析と課題一覧

### 3.1 実装済み機能（M0-M2）

| カテゴリ | 機能                                | 状態 | 備考                                |
| -------- | ----------------------------------- | :--: | ----------------------------------- |
| 基盤     | メタバースシーン（Metaverse.unity） |  OK  | NavMesh設定済み                     |
| 基盤     | 3D公園マップ                        |  OK  |                                     |
| シングル | 移動ボタンUI（前進/左/右）          |  OK  | MovementButtonUI.cs                 |
| シングル | 犬の移動制御（NavMeshAgent）        |  OK  | MetaverseDogController.cs           |
| シングル | プレイヤー追従                      |  OK  | MetaversePlayerFollower.cs          |
| シングル | アイソメトリックカメラ              |  OK  | MetaverseCamera.cs                  |
| シングル | 散歩終了UI + 確認ダイアログ         |  OK  | ExitWalkButton.cs                   |
| シングル | 10時トリガー + ポップアップ         |  OK  | WalkScheduler.cs + WalkTriggerUI.cs |
| マルチ   | Photon Fusion 2 Shared Mode接続     |  OK  | PhotonNetworkManager.cs             |
| マルチ   | 時間バケット自動マッチング          |  OK  | 30分間隔+連番方式                   |
| マルチ   | スポーン位置NavMeshスナップ         |  OK  | 地下スポーン防止済み                |
| マルチ   | プレイヤー名タグ表示                |  OK  | PlayerNameTag.cs（15m距離制限）     |
| マルチ   | 接続人数HUD表示                     |  OK  | MetaverseHUD.cs                     |
| マルチ   | Disconnect再入ガード                |  OK  | OnShutdownでフラグリセット済み      |

### 3.2 未実装・不完全な機能（要対応）

#### [CRITICAL] ネットワーク位置同期が未実装

**現状:** `NetworkDogController.cs` はアニメーションパラメータ（Speed, Direction, Yaw）のみを `[Networked]` で同期。**プレイヤーと犬のTransform（位置・回転）はネットワーク同期されていない。**

**影響:** 他プレイヤーから見ると、犬のアニメーションは再生されるが**実際の位置がズレていく**。10秒以上のセッションで顕著に発生。

**対応方針:**

- NetworkTransform コンポーネントをプレイヤー/犬のPrefabに追加
- 既存の `LateUpdate()` での回転オーバーライドと競合しないよう注意
- 補間方式: 線形補間（Lerp）、係数0.1（仕様書 Section 4.3.2準拠）

#### [CRITICAL] MAX_PLAYERS_PER_ROOM = 3（仕様は10）

**現状:** `NetworkConstants.cs` Line 9: `public const int MAX_PLAYERS_PER_ROOM = 3;`
**仕様:** 最大10人/ルーム

**対応:** 定数変更 + 10人接続時のパフォーマンステスト

#### [CRITICAL] バックグラウンド復帰処理が未実装

**現状:** `OnApplicationPause` / `OnApplicationFocus` のハンドラーが存在しない。

**仕様（Section 4.6.2）:**

- 30秒以内 → 自動復帰
- 30秒超過 → 退出扱い、メインシーンへ

**対応:** MetaverseManagerまたはPhotonNetworkManagerにライフサイクルハンドラーを追加

#### [MAJOR] 再接続ロジックの問題

**現状の問題点:**

1. **Rejoinでなく新規接続を試行** - 既存ルームへの復帰ができない（PLAYER_TTL_MS=60秒の間は復帰可能なはず）
2. **指数バックオフなし** - 同じ間隔（2秒）で3回リトライ（モバイルでは2s→4s→8s推奨）
3. **再接続中のUI表示なし** - ユーザーに何が起きているか伝わらない

#### [MAJOR] エラーハンドリングの不足

**仕様で定義されているが未実装のエラー:**

| コード | 状況                 | 必要な対応                                              |
| ------ | -------------------- | ------------------------------------------------------- |
| E001   | ネットワーク未接続   | 接続チェック + 「インターネットに接続してください」表示 |
| E004   | 接続中の切断         | 自動再接続（3回）+ 進捗UI                               |
| E005   | マイク権限なし       | M3向けだが基盤のみ先行で可                              |
| E006   | Photonサーバーエラー | メンテナンス案内表示                                    |

**OnShutdown** のシャットダウン理由マッピングが不足。`ShutdownReason` の各値に対して適切なエラーメッセージを出し分ける必要あり。

#### [MAJOR] 接続タイムアウト

**現状:** `MetaverseManager.cs` の初期化フローにタイムアウトがない。Photon接続が無限にハングする可能性。

**仕様（Section 4.1.2）:** 30秒タイムアウト

#### [MINOR] シーン遷移のフェード

**現状:** `SceneTransitionManager.cs` は `UniTask.Delay` で待つだけ。実際のフェードアウト/イン演出なし。

#### [MINOR] セキュリティバリデーション

- プレイヤー名の最大文字数チェックなし（仕様: 10文字）
- 接続時のタイムスタンプ検証なし

### 3.3 ファイル別完成度一覧

| ファイル                   | 完成度 | 主な課題                                                 | 優先度 |
| -------------------------- | :----: | -------------------------------------------------------- | :----: |
| PhotonNetworkManager.cs    |  70%   | タイムアウト未実装、再接続ロジック不完全                 |   高   |
| NetworkPlayerController.cs |  60%   | 位置同期なし、バリデーションなし                         |   高   |
| NetworkDogController.cs    |  60%   | 位置同期なし、回転オーバーライドがリスク                 |   高   |
| NetworkSpawnManager.cs     |  80%   | FindFirstObjectByTypeが低速、タイムアウトなし            |   中   |
| NetworkConstants.cs        |  90%   | MAX_PLAYERS=3（仕様は10）                                |   高   |
| MetaverseManager.cs        |  75%   | Photon失敗時のサイレントフォールバック、タイムアウトなし |   中   |
| SceneTransitionManager.cs  |  70%   | フェード未実装、タイムアウトなし                         |   低   |
| WalkScheduler.cs           |  90%   | ほぼ完成                                                 |   低   |
| MetaverseHUD.cs            |  80%   | デバッグ情報がリリースビルドで見えない                   |   低   |
| PlayerNameTag.cs           |  95%   | ほぼ完成                                                 |   -    |
| MetaverseDogController.cs  |  90%   | ローカル制御はほぼ完成                                   |   -    |
| MetaversePlayerFollower.cs |  90%   | 追従ロジック完成                                         |   -    |
| ExitWalkButton.cs          |  95%   | 完成                                                     |   -    |
| WalkTriggerUI.cs           |  85%   | 良好                                                     |   低   |
| MetaverseCamera.cs         |  90%   | カメラロジック完成                                       |   -    |

---

## 4. 技術要件・制約

### 4.1 開発環境（厳守）

| 項目                | バージョン                     | 備考                                   |
| ------------------- | ------------------------------ | -------------------------------------- |
| **Unity**           | 6000.2.8f1 (Unity 6)           | **厳密にこのバージョンを使用すること** |
| **Photon Fusion 2** | 現在インストール済みバージョン | パッケージロックファイル参照           |
| **C#**              | Unity対応バージョン            |                                        |
| **対象OS**          | Android 8.0以上                |                                        |
| **最小メモリ**      | 3GB RAM端末で動作              |                                        |
| **UniTask**         | 2.5.10                         | async/await基盤                        |

> **重要:** Unityバージョンの不一致はプロジェクト破損の原因になります。必ず指定バージョンで開発してください。

### 4.2 コーディング規約

既存コードベースのパターンに従ってください：

| パターン             | ルール                                                                      |
| -------------------- | --------------------------------------------------------------------------- |
| **async/await**      | UniTask を使用（System.Threading.Tasks ではなく）                           |
| **データ駆動**       | 設定値はScriptableObjectまたは定数クラスに定義（ハードコード禁止）          |
| **イベント駆動**     | システム間通信はScriptableObjectイベントまたはC#イベントを使用              |
| **コルーチン安全性** | 再入ガードとタイムアウトウォッチャーを必ず設置                              |
| **時間処理**         | 計算はUTC、表示時のみローカル変換（`TimeZoneUtility.cs` 参照）              |
| **ログ出力**         | `Debug.Log("[カテゴリ] メッセージ")` 形式（例: `[Photon]`, `[Metaverse]`）  |
| **命名規約**         | C# 標準（PascalCase for public, camelCase for private, \_prefix for field） |

### 4.3 Photon Fusion 2 固有の制約

| 制約            | 詳細                                                                      |
| --------------- | ------------------------------------------------------------------------- |
| **Shared Mode** | ホストモード・サーバーモードには変更しない                                |
| **リージョン**  | `jp`（日本）固定                                                          |
| **Tick Rate**   | 30 tick/秒                                                                |
| **同期方式**    | `[Networked]` 属性 + `NetworkTransform`                                   |
| **入力権限**    | 各プレイヤーは自分の入力のみ（`HasInputAuthority` / `HasStateAuthority`） |

### 4.4 既存アーキテクチャとの統合制約

```
メインシーン側:
  DogStateController.cs → 中央オーケストレーター（触らない）
  DogActionEngine.cs → アクション処理（触らない）
  GlobalVariables.cs → グローバル状態（PetState等を参照してよい）

メタバースシーン側:
  MetaverseManager.cs → エントリーポイント（修正可）
  PhotonNetworkManager.cs → ネットワーク管理（修正可）
  ※メインシーンのスクリプトへの依存は最小限に
```

### 4.5 Android固有の考慮事項

| 問題                        | 対応方針                                                                                     |
| --------------------------- | -------------------------------------------------------------------------------------------- |
| **Doze Mode**               | バッテリー最適化でネットワーク接続が切れる → OnApplicationPauseで検知                        |
| **バックグラウンド制限**    | Android 8.0以降のバックグラウンド実行制限 → フォアグラウンドサービスは不要（復帰時に再接続） |
| **画面回転**                | 固定（Portrait）                                                                             |
| **低メモリ端末**            | 追加メモリ100MB以下を目標                                                                    |
| **多様なAndroidバージョン** | API Level 26（Android 8.0）以上                                                              |

---

## 5. 受入基準（Definition of Done）

### 5.1 全体基準

以下をすべて満たした場合に「完了」とします：

- [ ] すべてのPriority 1項目が実装・テスト済み
- [ ] すべてのPriority 2項目が実装・テスト済み
- [ ] Priority 3のテスト項目がパスしている
- [ ] Android実機（最低2台）での動作確認済み
- [ ] 2人同時接続での散歩が10分以上安定動作
- [ ] Unity Editorでの警告（Warning）が新たに増加していない
- [ ] コードレビューを通過している

### 5.2 機能別受入基準

#### P1-1: ネットワーク位置同期

- [ ] プレイヤーAの犬の移動が、プレイヤーBの画面でリアルタイムに反映される
- [ ] 補間が適用され、カクつきなく移動が表示される
- [ ] 60秒以上のセッションで位置のズレが1m以内に収まる
- [ ] 静止時は同期頻度が下がりバッテリー消費を抑制

#### P1-2: MAX_PLAYERS_PER_ROOM

- [ ] 10人が同一ルームに接続できる
- [ ] 10人接続時にFPS 30以上を維持（対象: 3GB RAM端末）
- [ ] 11人目が接続を試みた際、別ルームにマッチングされる

#### P1-3: バックグラウンド復帰

- [ ] アプリをバックグラウンドにして15秒後に復帰 → 同じルームに戻る
- [ ] アプリをバックグラウンドにして60秒後に復帰 → メインシーンに戻る（エラーメッセージ付き）
- [ ] ホーム画面→アプリ復帰でクラッシュしない

#### P1-4: 再接続ロジック

- [ ] ネットワーク断後、自動で3回リトライ
- [ ] リトライ中にUIで「再接続中...（1/3）」のような表示
- [ ] 指数バックオフ（2秒→4秒→8秒）
- [ ] PLAYER_TTL（60秒）以内なら同じルームにRejoin
- [ ] 3回失敗後、「接続できませんでした」ダイアログ → メインシーンへ

#### P2-1: エラーダイアログ

- [ ] ネットワーク未接続時に「インターネットに接続してください」表示
- [ ] ルーム検索タイムアウト時に「接続できませんでした」+ リトライボタン
- [ ] 接続中切断時に再接続中UIが表示される
- [ ] エラーメッセージに技術用語を含まない（「サーバー」「タイムアウト」等を使わず平易な日本語）

### 5.3 非機能要件の受入基準

| 項目         | 基準                                    |
| ------------ | --------------------------------------- |
| FPS          | 10人接続時に30fps以上（3GB RAM端末）    |
| メモリ       | メタバースシーン追加メモリ100MB以下     |
| 入力遅延     | ボタン押下→画面反映が100ms以下          |
| 位置同期遅延 | 他プレイヤーの動きが150ms以下で反映     |
| バッテリー   | 30分散歩でバッテリー消費10%以下（目安） |

---

## 6. テスト要件

### 6.1 単体テスト（必須）

| 対象クラス              | テスト項目                                    |
| ----------------------- | --------------------------------------------- |
| PhotonNetworkManager    | ルーム接続/切断、再接続ロジック、タイムアウト |
| NetworkPlayerController | 位置同期、入力処理、名前バリデーション        |
| NetworkDogController    | 追従ロジック、アニメーション遷移              |
| WalkScheduler           | 時間判定、状態遷移                            |
| NetworkConstants        | 定数値の妥当性                                |

### 6.2 結合テスト（必須）

| シナリオ         | 手順                                | 期待結果                     |
| ---------------- | ----------------------------------- | ---------------------------- |
| 2人接続          | ParrelSyncで2エディタ起動→散歩開始  | 互いのプレイヤー+犬が見える  |
| 入退室           | Player Bが退出                      | Player A側でPlayer Bが消える |
| 再接続           | Player BのPCのネットを10秒切断→復旧 | Player Bが同じルームに復帰   |
| シーン往復       | メイン→メタバース→メイン→メタバース | クラッシュせず正常動作       |
| バックグラウンド | エディタを最小化→15秒後に復帰       | セッション継続               |

### 6.3 ネットワークテスト（推奨）

| 条件               | 確認項目               |
| ------------------ | ---------------------- |
| Wi-Fi環境          | 正常動作               |
| 4G環境             | 150ms以下の遅延で動作  |
| パケットロス5%相当 | 動作継続、リカバリ可能 |
| 切断→再接続        | 自動復帰成功           |

### 6.4 実機テスト（必須）

| 端末カテゴリ | 条件       | 確認項目                   |
| ------------ | ---------- | -------------------------- |
| 低スペック   | 3GB RAM    | FPS 30以上、クラッシュなし |
| 中スペック   | 6GB RAM    | FPS 60維持                 |
| 画面サイズ   | 複数解像度 | UIレイアウト崩れなし       |

### 6.5 テスト環境

- **ParrelSync**: 複数エディタでのマルチプレイヤーテスト（セットアップ済み → `docs/metaverse_walk/parrelsync_test_guide.md` 参照）
- **Photon AppId**: 開発用と本番用を分離すること（[9. セキュリティ](#9-セキュリティ機密情報の取り扱い) 参照）

---

## 7. 納品物・成果物

### 7.1 必須納品物

| #   | 成果物             | 形式                    | 備考                           |
| --- | ------------------ | ----------------------- | ------------------------------ |
| 1   | ソースコード       | Git ブランチ（PR形式）  | main ブランチへのPR            |
| 2   | テストコード       | Unity Test Runner形式   | EditMode + PlayMode            |
| 3   | テスト結果レポート | Markdown                | 全テストケースの実行結果       |
| 4   | 変更差分説明書     | Markdown                | 変更したファイル一覧と変更理由 |
| 5   | 実機テスト結果     | スクリーンショット/動画 | Android 2台以上                |

### 7.2 推奨納品物

| #   | 成果物                     | 形式               | 備考           |
| --- | -------------------------- | ------------------ | -------------- |
| 6   | パフォーマンスプロファイル | Unity Profiler出力 | 10人接続時     |
| 7   | 既知の制限事項一覧         | Markdown           | 将来の改善候補 |

### 7.3 納品形式

- **Git運用:** feature ブランチで開発 → PR で納品
- **ブランチ名規約:** `feature/metaverse-m2-production` または作業単位で分割
- **コミットメッセージ:** 日本語OK、変更内容が分かる粒度
- **PR:** 変更概要・テスト手順を記載

---

## 8. 開発環境セットアップ

### 8.1 外注先に提供するもの

| #   | 提供物                       | 提供方法                                             | 注意事項                  |
| --- | ---------------------------- | ---------------------------------------------------- | ------------------------- |
| 1   | Gitリポジトリアクセス        | GitHub招待                                           | Collaborator権限（Write） |
| 2   | Unity プロジェクト一式       | リポジトリに含まれる                                 |                           |
| 3   | Photon App ID（開発用）      | 別途共有                                             | **本番用IDは渡さない**    |
| 4   | 仕様書一式                   | `docs/metaverse_walk/`                               |                           |
| 5   | ParrelSyncセットアップガイド | `docs/metaverse_walk/parrelsync_test_guide.md`       |                           |
| 6   | エディタセットアップガイド   | `docs/metaverse_walk/metaverse_walk_editor_setup.md` |                           |

### 8.2 外注先が準備するもの

| #   | 必要なもの                 | 備考                     |
| --- | -------------------------- | ------------------------ |
| 1   | Unity 6000.2.8f1           | **厳密に同一バージョン** |
| 2   | Android SDK                | API Level 26以上         |
| 3   | Android実機                | 最低2台（テスト用）      |
| 4   | 安定したインターネット接続 | マルチプレイヤーテスト用 |

### 8.3 セットアップ手順

```
1. リポジトリをクローン
2. Unity Hub → Add → プロジェクトフォルダを指定
3. Unity 6000.2.8f1 で開く
4. Assets → Play Services Resolver → Android Resolver → Resolve
5. Photon App ID を PhotonAppSettings に設定
6. ParrelSync → Clones Manager → Create Clone（マルチプレイヤーテスト用）
7. Build Settings → Android → Switch Platform
```

---

## 9. セキュリティ・機密情報の取り扱い

### 9.1 共有してはいけないもの

| 情報                         | 理由                                 | 対応                                           |
| ---------------------------- | ------------------------------------ | ---------------------------------------------- |
| **本番用 Photon App ID**     | 本番環境の汚染防止                   | 開発用AppIDを別途作成して渡す                  |
| **Firebase credentials**     | google-services.json内の本番認証情報 | メタバース機能には不要。必要ならダミー値を提供 |
| **Keystore ファイル (.jks)** | APK署名用の秘密鍵                    | 渡さない。ビルドは弊社側で実施                 |
| **本番ユーザーデータ**       | 個人情報保護                         | テストデータのみ使用                           |

### 9.2 Photon開発環境の分離

```
本番環境:
  Photon App ID: [本番用] → 外注先には非公開
  リージョン: jp

開発環境（外注先用）:
  Photon App ID: [開発用] → 外注先に提供
  リージョン: jp
  プラン: Free（100 CCU）で十分
```

**Photon Dashboard で開発用アプリを別途作成し、そのApp IDを渡す。**

### 9.3 NDA（秘密保持契約）

外注開始前に以下を締結することを推奨：

- ソースコードの第三者への開示禁止
- プロジェクト完了後のローカルコピー削除
- スクリーンショット・動画の外部公開禁止

---

## 10. コミュニケーション・進行管理

### 10.1 推奨コミュニケーション体制

| 頻度                     | 内容               | 形式                       |
| ------------------------ | ------------------ | -------------------------- |
| **週1回**                | 進捗報告・デモ     | ビデオ通話（30分）         |
| **随時**                 | 技術的な質問・相談 | Slack / Discord / チャット |
| **マイルストーン完了時** | レビュー・受入確認 | ビデオ通話 + PR レビュー   |

### 10.2 進捗管理

**推奨:** GitHub Issues または Projects で管理

```
各作業項目（P1-1, P1-2, ...）をIssue化
→ ステータス: Todo / In Progress / Review / Done
→ PRはIssue番号を参照
```

### 10.3 質問・仕様確認のフロー

```
外注先からの質問
  → まず既存ドキュメント（docs/metaverse_walk/）を確認
  → ドキュメントで解決しない場合 → チャットで質問
  → 仕様変更が必要な場合 → ビデオ通話で合意 → ドキュメント更新
```

### 10.4 コードレビュー方針

| 観点                 | チェック内容                                           |
| -------------------- | ------------------------------------------------------ |
| 機能                 | 受入基準を満たしているか                               |
| 既存コードとの整合性 | アーキテクチャパターンに従っているか                   |
| エッジケース         | ネットワーク断、メモリ不足等の異常系                   |
| パフォーマンス       | 不要なアロケーション、毎フレーム処理の最適化           |
| 高齢者UX             | フォントサイズ、ボタンサイズ、エラーメッセージの平易さ |

---

## 11. 契約・発注上の注意点

### 11.1 支払い方式の選択

| 方式                       | メリット                                               | デメリット                         |    推奨度    |
| -------------------------- | ------------------------------------------------------ | ---------------------------------- | :----------: |
| **マイルストーン分割払い** | 進捗に応じた支払い。リスク分散                         | マイルストーン定義が必要           |   **推奨**   |
| 一括固定                   | シンプル                                               | 品質リスク。手戻り時にコスト不透明 |    非推奨    |
| 時間単価（時給/日給）      | 柔軟。マルチプレイヤーのバグは工数が読みにくいため有利 | 上限管理が必要                     | 条件付き推奨 |

**推奨: マイルストーン分割 + 超過分は時間単価**

```
支払いスケジュール例:
  着手金: 20%（契約時）
  Priority 1 完了: 40%（レビュー通過後）
  Priority 2 完了: 25%（レビュー通過後）
  Priority 3 + 最終納品: 15%（受入テスト通過後）
```

### 11.2 マルチプレイヤー特有のリスクと契約への反映

> **経験者からの最重要アドバイス:**
> マルチプレイヤー機能の不具合は**再現が非常に困難**です。「10回に1回しか起きない」「3人以上で特定の順序で操作した時だけ発生する」といったバグが頻発します。

**契約に含めるべき条項:**

1. **バグ修正期間の設定**
   - 納品後30日間は無償バグ修正期間とする
   - ネットワーク関連のバグは再現手順の提供が必要
   - 「再現できないバグ」の取り扱いを事前に合意

2. **テスト環境の負担**
   - Photon CCU の開発用コストは発注者負担（Free枠で十分だが確認）
   - 実機テスト用端末は外注先が用意

3. **仕様変更の扱い**
   - スコープ外の作業依頼は別途見積もり
   - 「やってみたら想定より複雑だった」場合の取り扱いを合意

### 11.3 知的財産権

- 成果物の著作権は発注者に帰属
- 外注先はポートフォリオへの掲載不可（NDA準拠）
- 汎用ライブラリ部分は協議の上で決定

---

## 12. リスク管理

### 12.1 技術リスク

| リスク                                     | 影響度 | 発生確率 | 対策                                                      |
| ------------------------------------------ | :----: | :------: | --------------------------------------------------------- |
| Photon Fusion 2 の経験不足                 |   高   |    中    | **面接時にFusion 2（PUNではなく）の実績を確認**           |
| NetworkTransform追加時の既存コードとの競合 |   中   |    高    | LateUpdate回転オーバーライドの共存テストを先行            |
| 10人接続時のパフォーマンス問題             |   高   |    中    | 早期に10人テストを実施。3人でOKでも10人で崩れるケースあり |
| Android Doze Modeの挙動が端末により異なる  |   中   |    高    | 複数メーカー端末でテスト（Samsung, Google, Xiaomi等）     |
| Photon SDK のバージョン非互換              |   高   |    低    | パッケージロックファイルを厳守。勝手にアップデートしない  |

### 12.2 プロジェクトリスク

| リスク                               | 影響度 | 発生確率 | 対策                                  |
| ------------------------------------ | :----: | :------: | ------------------------------------- |
| スコープクリープ                     |   中   |    高    | スコープ外を明確に文書化済み（2.3節） |
| コミュニケーション不足による認識齟齬 |   高   |    中    | 週1デモ。初週は毎日短時間MTG推奨      |
| 途中離脱                             |   高   |    低    | マイルストーン分割払いでリスクヘッジ  |
| 既存コードの理解不足                 |   中   |    中    | 初週はオンボーディング期間として確保  |

### 12.3 リスク発生時のエスカレーション

```
レベル1（外注先で解決可能）:
  → チャットで相談、翌営業日までに返答

レベル2（仕様変更が必要）:
  → ビデオ通話でディスカッション
  → 合意内容をドキュメント更新

レベル3（プロジェクト継続に影響）:
  → 即座にビデオ通話
  → スケジュール/スコープ再調整
```

---

## 13. 外注先選定チェックリスト

### 13.1 技術スキル（必須）

- [ ] **Photon Fusion 2** の実務経験がある（PUN/PUN2だけでは不可）
- [ ] **Shared Mode** での開発経験がある
- [ ] Unity のマルチプレイヤーゲーム開発経験がある
- [ ] Android向けUnityアプリの開発・リリース経験がある
- [ ] C# の async/await パターンに習熟している

### 13.2 技術スキル（推奨）

- [ ] UniTask の使用経験
- [ ] NavMesh を使った移動制御の経験
- [ ] モバイルのネットワーク最適化経験（4G/LTE環境のハンドリング）
- [ ] Unity Test Runner でのテスト作成経験
- [ ] ParrelSync でのマルチプレイヤーデバッグ経験

### 13.3 面接時の確認ポイント

**技術的な質問例（経験を見極めるため）:**

1. 「Photon Fusion 2 の Shared Mode と Host Mode の違いを説明してください」
   → Shared Modeの特性（State Authority分散、ホスト不要）を理解しているか

2. 「ネットワーク切断から再接続する際、Rejoin と新規接続の違いは何ですか？」
   → PLAYER_TTL、SessionInfo保持の理解があるか

3. 「NetworkTransform の補間方式にはどのような選択肢がありますか？」
   → Lerp, SnapShot Interpolation等の知識があるか

4. 「Android端末がDoze Modeに入った場合、Photon接続はどうなりますか？」
   → モバイル固有の問題を理解しているか

5. 「10人同時接続で帯域を最適化する方法を挙げてください」
   → AOI（Area of Interest）、同期頻度調整、Delta Compression等

**ポートフォリオ確認:**

- マルチプレイヤー機能のあるプロジェクトを見せてもらう
- 可能であれば動作デモを見る

### 13.4 コミュニケーション能力

- [ ] 技術的な問題を非エンジニアにも分かりやすく説明できる
- [ ] 進捗が遅れる場合に早めに報告する姿勢がある
- [ ] 仕様の不明点を自発的に質問できる

---

## 付録

### A. 参考ドキュメント一覧

| ドキュメント         | パス                                                        | 内容                       |
| -------------------- | ----------------------------------------------------------- | -------------------------- |
| 完全仕様書           | `docs/metaverse_walk/tappu_metaverse_walk_specification.md` | 1100行の詳細仕様           |
| 実装ロードマップ     | `docs/metaverse_walk/README.md`                             | M0-M4の概要                |
| ネットワーク仕様     | `docs/metaverse_walk/metaverse_walk_network.md`             | Photon Fusion 2の詳細      |
| シーン設計           | `docs/metaverse_walk/metaverse_walk_scene.md`               | メタバースシーンの構成     |
| 散歩トリガー         | `docs/metaverse_walk/metaverse_walk_trigger.md`             | 10時トリガーの仕様         |
| エディタセットアップ | `docs/metaverse_walk/metaverse_walk_editor_setup.md`        | 開発環境構築手順           |
| ParrelSyncガイド     | `docs/metaverse_walk/parrelsync_test_guide.md`              | マルチプレイヤーテスト手順 |

### B. 関連スクリプトのパス

```
Assets/Scripts/MetaverseWalk/
├── Core/
│   ├── MetaverseManager.cs          # エントリーポイント
│   ├── WalkScheduler.cs             # 散歩スケジューラ
│   ├── SceneTransitionManager.cs    # シーン遷移
│   └── MetaverseConstants.cs        # 定数
├── Network/
│   ├── PhotonNetworkManager.cs      # Photon接続管理
│   ├── NetworkPlayerController.cs   # プレイヤー同期
│   ├── NetworkDogController.cs      # 犬の同期
│   ├── NetworkSpawnManager.cs       # スポーン管理
│   ├── NetworkConstants.cs          # ネットワーク定数
│   └── PlayerNameTag.cs             # 名前タグ
├── Dog/
│   └── MetaverseDogController.cs    # 犬のローカル制御
├── Movement/
│   └── MetaversePlayerFollower.cs   # プレイヤー追従
├── Camera/
│   └── MetaverseCamera.cs          # カメラ制御
├── UI/
│   ├── WalkTriggerUI.cs            # 散歩開始UI
│   ├── MetaverseHUD.cs             # HUD
│   ├── MovementButtonUI.cs         # 移動ボタン
│   ├── ExitWalkButton.cs           # 散歩終了ボタン
│   ├── WalkConfirmPopup.cs         # 確認ポップアップ
│   └── HoldButton.cs              # ボタンハンドラー
└── Debug/
    └── MetaverseTestBootstrap.cs   # テスト用
```

### C. 用語集

| 用語             | 説明                                                       |
| ---------------- | ---------------------------------------------------------- |
| Photon Fusion 2  | Unity向けマルチプレイヤーネットワークライブラリ            |
| Shared Mode      | ホスト不要の分散権限モード                                 |
| CCU              | Concurrent Users（同時接続ユーザー数）                     |
| Tick             | Fusionのシミュレーション単位（30tick/秒 = 約33ms）         |
| NetworkTransform | 位置・回転を自動同期するFusionコンポーネント               |
| State Authority  | オブジェクトの状態を書き換える権限                         |
| Input Authority  | 入力を送信する権限                                         |
| ParrelSync       | Unity Editorを複数起動してマルチプレイヤーテストするツール |
| NavMesh          | Unityの経路探索用メッシュ                                  |
| UniTask          | Unity向けasync/awaitライブラリ                             |
| PlayerPrefs      | Unityのローカル永続化ストレージ                            |
| Doze Mode        | Androidのバッテリー節約モード                              |

必要なEditor作業  
 A. 人アバター（NetworkPlayerプレハブの差し替え） 現在のプレハブ:  
 Assets/Resources/MetaverseWalk/NetworkPlayer.prefab

手順:

1. 新しいプレハブを作成

- 既存の NetworkPlayer.prefab を複製（右クリック →
  Duplicate）
- 新しい人モデルのメッシュ/マテリアルに差し替え

2. 以下のコンポーネントが必ず残っていること確認

コンポーネント: NetworkObject
必須: 必須
役割: Photon同期の基盤
────────────────────────────────────────
コンポーネント: NetworkTransform
必須: 必須
役割: 位置/回転の自動同期
────────────────────────────────────────
コンポーネント: NetworkPlayerController
必須: 必須
役割: 名前・アニメ・位置のカスタム同期
────────────────────────────────────────
コンポーネント: MetaversePlayerFollower
必須: 必須
役割: 犬に自動追従
────────────────────────────────────────
コンポーネント: NavMeshAgent
必須: 必須
役割: 地形上の移動（新マップのNavMeshを歩く）
────────────────────────────────────────
コンポーネント: Animator
必須: 必須
役割: Speed パラメータ（float）が必要
────────────────────────────────────────
コンポーネント: PlayerNameTag
必須: 必須
役割: 他プレイヤーの頭上に名前表示

3. Animatorの設定

- 新しい人モデル用のAnimatorControllerを作成
- Speed パラメータ（float, 0〜1）を必ず追加 —
  これが歩行アニメの制御に使われます
- Idle → Walk のBlendTreeまたはTransitionを設定

4. NetworkPlayerControllerのInspector確認

- Animator フィールドに新モデルのAnimatorをドラッグ

---

B. 犬アバター（NetworkDogプレハブの差し替え）

現在のプレハブ:
Assets/Resources/MetaverseWalk/NetworkDog.prefab

犬も人に変えるなら同様の手順で：

必須コンポーネント:

コンポーネント: NetworkObject
必須: 必須
役割: Photon同期の基盤
────────────────────────────────────────
コンポーネント: NetworkDogController
必須: 必須
役割: Speed/Direction/IsWalking/Yaw/Positionの同期
────────────────────────────────────────
コンポーネント: MetaverseDogController
必須: 必須
役割: ボタン操作での移動制御
────────────────────────────────────────
コンポーネント: NavMeshAgent
必須: 必須
役割: 地形上の移動
────────────────────────────────────────
コンポーネント: Animator
必須: 必須
役割: 下記3パラメータが必要
────────────────────────────────────────
コンポーネント: Rigidbody
必須: 必須
役割: Is Kinematic = ON

Animatorの必須パラメータ:

- DogWalkSpeed（float, 0〜1）— 歩行速度
- Direction（float, -1〜1）— 左右旋回
- IsWalking（bool）— 歩行中かどうか

人アバターに変えてもパラメータ名はそのまま使えます（内部名
なのでUIには見えない）。

---

C. 新マップの接続

1. NavMeshのベイク（最重要）

犬もプレイヤーもNavMeshAgent
で移動するので、NavMeshが無いと動けません。

- 新マップの地面メッシュを選択
- Inspector → Static → Navigation Static にチェック
- Window → AI → Navigation を開く
- Bake タブ → パラメータ設定:
  - Agent Radius: 0.3（キャラの半径）
  - Agent Height: 1.8（人の高さ）
  - Max Slope: 45
  - Step Height: 0.4
- Bake ボタンを押す
- 青い面が表示されれば成功

2. スポーンポイントの配置

PhotonNetworkManager が使うスポーンポイント（現在5箇所）を
新マップに合わせて移動：

- Hierarchy で SpawnPoint_01 〜 SpawnPoint_05 を選択
- 新マップのNavMesh上の歩ける場所に移動
- 各ポイントは少し離して配置（プレイヤー同士が重ならないよ
  う）

3. MetaverseManagerのスポーンポイント確認

- Hierarchy で MetaverseManager を選択
- Inspector の Dog Spawn Point / Player Spawn Point  
  が新マップの適切な位置を指しているか確認

4. PhotonNetworkManagerのプレハブ割り当て

新しいプレハブを作った場合：

- Hierarchy で PhotonNetworkManager を選択
- Inspector:
  - Network Dog Prefab ← 新しいDogプレハブをドラッグ
  - Network Player Prefab ← 新しいPlayerプレハブをドラッグ
  - Spawn Points 配列 ←
    5つのスポーンポイントが割り当てられているか確認

---

D. 確認チェックリスト

#: 1
確認項目: NavMeshがベイクされている
方法: Window → AI → Navigation → 青い面が見える
────────────────────────────────────────
#: 2
確認項目: スポーンポイントがNavMesh上にある
方法: SpawnPointを選択 → Scene
viewで青い面の上に乗っているか
────────────────────────────────────────
#: 3
確認項目: プレハブにNetworkObjectがある
方法: プレハブを開いて Inspector確認
────────────────────────────────────────
#: 4
確認項目: AnimatorパラメータがID一致
方法: Dog: DogWalkSpeed, Direction, IsWalking / Player:  
 Speed
────────────────────────────────────────
#: 5
確認項目: PhotonNetworkManagerにプレハブ割当済
方法: Metaverse.unity → PhotonNetworkManager Inspector  
 ────────────────────────────────────────
#: 6
確認項目: プレハブが Resources/MetaverseWalk/ にある  
 方法: Fusionがこのパスからロードする
────────────────────────────────────────
#: 7
確認項目: Play → 犬/人が地面に立って動く
方法: NavMeshが正しければ地面にスナップする

最も重要なのは「NavMeshのベイク」と「プレハブへのNetworkObj
ect維持」です。 この2つが欠けると、地面を歩けない or  
 ネットワーク同期できない状態になります。
