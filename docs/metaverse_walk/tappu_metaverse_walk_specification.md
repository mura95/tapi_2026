# Tappu メタバース散歩機能 仕様書

**バージョン**: 1.0  
**作成日**: 2025年2月  
**ステータス**: ドラフト

---

## 目次

1. [概要](#1-概要)
2. [システム構成](#2-システム構成)
3. [画面設計](#3-画面設計)
4. [機能要件](#4-機能要件)
5. [ネットワーク仕様](#5-ネットワーク仕様)
6. [音声通話仕様](#6-音声通話仕様)
7. [データ構造](#7-データ構造)
8. [シーケンス図](#8-シーケンス図)
9. [エラーハンドリング](#9-エラーハンドリング)
10. [セキュリティ](#10-セキュリティ)
11. [パフォーマンス要件](#11-パフォーマンス要件)
12. [高齢者向けUX設計](#12-高齢者向けux設計)
13. [テスト要件](#13-テスト要件)
14. [将来の拡張性](#14-将来の拡張性)
15. [用語集](#15-用語集)

---

## 1. 概要

### 1.1 目的

高齢者ユーザーが他のユーザーと一緒にバーチャル空間で犬の散歩を楽しみ、音声で会話できる機能を提供する。社会的孤立の解消と日常的なつながりの創出を目指す。

### 1.2 背景

- 高齢者の約3割が社会的孤立状態にある
- 既存のデジタルペットには他者との交流機能がない
- 「散歩」という日常的な行為を通じた自然なコミュニケーション機会を提供

### 1.3 スコープ

**対象範囲:**
- マルチプレイヤールーム接続機能
- プレイヤー・犬の同期機能
- 近接音声通話機能
- シーン遷移機能
- 関連UI

**対象外:**
- アバターカスタマイズ機能
- フレンド機能
- テキストチャット機能
- マップエディター機能

### 1.4 対象プラットフォーム

| 項目 | 内容 |
|------|------|
| OS | Android 8.0以上 |
| Unity | 2022.3 LTS |
| 最小メモリ | 3GB RAM |
| ネットワーク | Wi-Fi / 4G LTE以上推奨 |

---

## 2. システム構成

### 2.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      Photon Cloud                            │
│  ┌──────────────────────┐    ┌──────────────────────┐       │
│  │   Fusion Server      │    │   Voice Server       │       │
│  │  ・ルーム管理         │    │  ・音声ルーティング   │       │
│  │  ・状態同期           │    │  ・コーデック処理     │       │
│  │  ・入力処理           │    │  ・帯域最適化        │       │
│  └──────────┬───────────┘    └──────────┬───────────┘       │
└─────────────┼──────────────────────────┼────────────────────┘
              │                          │
              │    WebSocket / UDP       │
              │                          │
    ┌─────────┴──────────────────────────┴─────────┐
    │                                              │
┌───┴───┐  ┌───┴───┐  ┌───┴───┐       ┌───┴───┐
│Client │  │Client │  │Client │  ...  │Client │
│  A    │  │  B    │  │  C    │       │  J    │
└───────┘  └───────┘  └───────┘       └───────┘
  （最大10クライアント/ルーム）
```

### 2.2 使用技術スタック

| レイヤー | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| エンジン | Unity | 6000 LTS | アプリ基盤 |
| ネットワーク同期 | Photon Fusion 2 | 最新安定版 | 位置・状態同期 |
| 音声通話 | Photon Voice 2 | 最新安定版 | リアルタイム音声 |
| UI | Unity UI Toolkit または uGUI | - | ユーザーインターフェース |
| 音声処理 | Unity Audio | - | 3D音響・音量制御 |

### 2.3 Unityプロジェクト構成

```
Assets/
├── Scenes/
│   ├── MainScene.unity      # 既存メインシーン
│   └── MetaverseWalkScene.unity  # 新規：散歩シーン
├── Scripts/
│   ├── Network/
│   │   ├── NetworkManager.cs
│   │   ├── RoomManager.cs
│   │   └── NetworkInputData.cs
│   ├── Player/
│   │   ├── PlayerController.cs
│   │   ├── PlayerSpawner.cs
│   │   ├── PlayerNameDisplay.cs
│   │   └── PlayerData.cs
│   ├── Dog/
│   │   ├── DogController.cs
│   │   ├── DogFollowBehavior.cs
│   │   └── DogAnimationController.cs
│   ├── Voice/
│   │   ├── VoiceManager.cs
│   │   ├── ProximityVoiceSpeaker.cs
│   │   └── VoiceIndicator.cs
│   ├── UI/
│   │   ├── WalkTriggerUI.cs
│   │   ├── MetaverseHUD.cs
│   │   ├── MuteButton.cs
│   │   └── ConnectionStatusUI.cs
│   └── Walk/
│       ├── WalkScheduler.cs
│       └── SceneTransitionManager.cs
├── Prefabs/
│   ├── NetworkPlayer.prefab
│   ├── NetworkDog.prefab
│   └── UI/
├── Resources/
│   └── PhotonAppSettings.asset
└── Settings/
    └── AudioMixerSettings.asset
```

---

## 3. 画面設計

### 3.1 画面遷移図

```
┌─────────────────────────────────────────────────────────────┐
│                    TappuMainScene                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │                   犬の画面                          │    │
│  │                                                     │    │
│  │              ┌─────────────┐                        │    │
│  │              │  🐕 犬      │                        │    │
│  │              │             │                        │    │
│  │              └─────────────┘                        │    │
│  │                    │                                │    │
│  │         （10時になると表示）                         │    │
│  │                    ↓                                │    │
│  │              ┌─────────────┐                        │    │
│  │              │ 散歩に行く  │ ← ボタン               │    │
│  │              └──────┬──────┘                        │    │
│  └─────────────────────┼───────────────────────────────┘    │
└────────────────────────┼────────────────────────────────────┘
                         │ タップ
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                   LoadingScreen                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │              「散歩の準備中...」                     │    │
│  │              [=========>    ] 70%                   │    │
│  │                                                     │    │
│  │         ・ルーム検索中 ✓                            │    │
│  │         ・接続中...                                 │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                         │ 接続完了
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                 MetaverseWalkScene                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ [散歩やめる] [🎤]                    [👥 3人]       │    │
│  │                                                     │    │
│  │        田中さん                                     │    │
│  │          🧑‍🦳🐕                                       │    │
│  │                    💬 ← 音声インジケーター          │    │
│  │              🧓🐕                                    │    │
│  │            山田さん                                 │    │
│  │                                                     │    │
│  │    👴🐕                                             │    │
│  │  （自分）                                           │    │
│  │                                                     │    │
│  │  ～～～～～ 公園マップ ～～～～～                    │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                         │ 「散歩やめる」タップ
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                   確認ダイアログ                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │         散歩を終了しますか？                        │    │
│  │                                                     │    │
│  │         [はい]        [いいえ]                      │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                         │ 「はい」タップ
                         ↓
                  TappuMainSceneに戻る
```

### 3.2 メインシーン UI詳細（散歩トリガー）

#### 3.2.1 散歩ボタン

| 項目 | 仕様 |
|------|------|
| 表示条件 | 設定された時間帯（デフォルト10:00-11:00） |
| 位置 | 犬の上部、中央揃え |
| サイズ | 200 x 80 px（高齢者向けに大きめ） |
| テキスト | 「散歩に行く」 |
| フォントサイズ | 32px |
| 背景色 | #4CAF50（緑系、アクティブ感） |
| テキスト色 | #FFFFFF |
| 角丸 | 16px |
| アニメーション | ゆっくり上下に浮遊（0.5秒周期、5px振幅） |

#### 3.2.2 犬の「散歩したい」演出

| 項目 | 仕様 |
|------|------|
| アニメーション | 尻尾を振る速度UP、小さくジャンプ |
| エフェクト | 犬の周囲にハートマーク（💕）を表示 |
| 効果音 | 「ワンワン」鳴き声（2回、間隔1秒） |
| 吹き出し | 「散歩行きたい！」テキスト表示（オプション） |

### 3.3 メタバースシーン UI詳細

#### 3.3.1 HUD（ヘッドアップディスプレイ）

```
┌─────────────────────────────────────────────────────────┐
│ ┌──────────┐  ┌────┐                      ┌─────────┐  │
│ │散歩やめる │  │ 🎤 │                      │ 👥 3人  │  │
│ └──────────┘  └────┘                      └─────────┘  │
│   左上         左上                           右上      │
│                                                        │
│                                                        │
│                      （ゲーム画面）                      │
│                                                        │
│                                                        │
│                                        ┌────────────┐  │
│                                        │ 🕹️ 移動    │  │
│                                        │ ジョイス   │  │
│                                        │ ティック   │  │
│                                        └────────────┘  │
│                                           右下          │
└─────────────────────────────────────────────────────────┘
```

#### 3.3.2 各UI要素の仕様

**散歩やめるボタン**

| 項目 | 仕様 |
|------|------|
| 位置 | 左上、セーフエリア内（上20px、左20px） |
| サイズ | 160 x 60 px |
| テキスト | 「散歩やめる」 |
| フォントサイズ | 24px |
| 背景色 | #FF6B6B（赤系、終了を示唆） |
| テキスト色 | #FFFFFF |

**ミュートボタン**

| 項目 | 仕様 |
|------|------|
| 位置 | 散歩やめるボタンの右隣（間隔16px） |
| サイズ | 60 x 60 px |
| アイコン | マイクON 🎤 / マイクOFF 🔇 |
| 背景色 | ON時 #4CAF50 / OFF時 #9E9E9E |
| タップ反応 | アイコン切り替え + 効果音 |

**参加人数表示**

| 項目 | 仕様 |
|------|------|
| 位置 | 右上、セーフエリア内 |
| サイズ | 自動（テキスト幅に応じる） |
| テキスト | 「👥 N人」（Nはルーム内人数） |
| フォントサイズ | 20px |
| 背景色 | #000000（不透明度50%） |
| 更新タイミング | プレイヤー入退室時 |

**バーチャルジョイスティック**

| 項目 | 仕様 |
|------|------|
| 位置 | 右下（右端から40px、下端から40px） |
| サイズ | 外円 150px、内円 60px |
| 不透明度 | 非操作時 50%、操作時 80% |
| 感度 | 0.5〜1.0（設定で変更可能） |
| デッドゾーン | 内円から10px以内は無反応 |

#### 3.3.3 プレイヤー名表示

| 項目 | 仕様 |
|------|------|
| 位置 | プレイヤーアバターの頭上（Y + 2.0m） |
| フォント | 太字、白色、黒アウトライン |
| フォントサイズ | 画面上で常に一定サイズ（スケーリング） |
| 最大文字数 | 10文字（超過は「...」で省略） |
| 表示距離 | 15m以内のプレイヤーのみ表示 |
| 自分の名前 | 非表示 |

#### 3.3.4 音声インジケーター

| 項目 | 仕様 |
|------|------|
| 表示条件 | 音声送信中のプレイヤー |
| 位置 | プレイヤー名の左横 |
| アイコン | 🔊 または音波アニメーション |
| 色 | 音量に応じて緑→黄→赤にグラデーション |

---

## 4. 機能要件

### 4.1 散歩トリガー機能

#### 4.1.1 時間トリガー

| 項目 | 仕様 |
|------|------|
| ID | FN-001 |
| 機能名 | 散歩時間通知 |
| 説明 | 設定された時間になると犬が散歩をねだる演出を開始 |
| デフォルト時間 | 10:00 |
| 時間設定 | 将来的にユーザーが変更可能（今回は固定） |
| 判定間隔 | 1分ごとにチェック |
| 持続時間 | 散歩トリガー時間帯は1時間（10:00-11:00） |
| 複数回表示 | 一度「散歩に行く」を押さずに閉じた場合、5分後に再表示 |

#### 4.1.2 散歩開始処理

| 項目 | 仕様 |
|------|------|
| ID | FN-002 |
| 機能名 | 散歩開始 |
| トリガー | 「散歩に行く」ボタンタップ |
| 処理順序 | 1. ボタン無効化 → 2. ローディング表示 → 3. ルーム接続 → 4. シーン遷移 |
| タイムアウト | 30秒（超過時はエラー表示） |

### 4.2 ルーム管理機能

#### 4.2.1 ルーム自動マッチング

| 項目 | 仕様 |
|------|------|
| ID | FN-003 |
| 機能名 | 自動ルームマッチング |
| ロジック | 空きのあるルームを検索し、なければ新規作成 |
| 最大人数 | 10人/ルーム |
| ルーム名 | 自動生成（"Walk_" + タイムスタンプ + ランダム文字列） |
| 検索条件 | 空き1人以上、作成から30分以内 |
| リージョン | jp（日本）固定 |

```csharp
// マッチングロジック擬似コード
async Task<SessionInfo> FindOrCreateRoom()
{
    // 1. 既存ルームを検索
    var rooms = await GetAvailableRooms();
    var suitableRoom = rooms
        .Where(r => r.PlayerCount < r.MaxPlayers)
        .Where(r => r.CreatedAt > DateTime.Now.AddMinutes(-30))
        .OrderByDescending(r => r.PlayerCount)  // 人が多いルーム優先
        .FirstOrDefault();
    
    if (suitableRoom != null)
        return suitableRoom;
    
    // 2. なければ新規作成
    return await CreateNewRoom();
}
```

#### 4.2.2 ルーム設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| GameMode | Shared | ホスト不要の共有モード |
| MaxPlayers | 10 | 最大同時接続数 |
| IsVisible | true | ルームリストに表示 |
| IsOpen | true | 新規参加を許可 |
| EmptyRoomTtl | 300000 | 空室後5分で削除（ミリ秒） |
| PlayerTtl | 60000 | 切断後1分間は再接続可能（ミリ秒） |

### 4.3 プレイヤー同期機能

#### 4.3.1 プレイヤー生成

| 項目 | 仕様 |
|------|------|
| ID | FN-004 |
| 機能名 | プレイヤースポーン |
| タイミング | ルーム参加完了時 |
| スポーン位置 | マップ中央付近のランダム位置（半径5m以内） |
| スポーン時演出 | フェードイン（0.5秒） |
| 生成物 | プレイヤーアバター + 犬（子オブジェクト） |

#### 4.3.2 位置同期

| 項目 | 仕様 |
|------|------|
| ID | FN-005 |
| 機能名 | 位置・回転同期 |
| 同期対象 | Position (Vector3), Rotation (Quaternion) |
| 同期レート | 30 tick/秒 |
| 補間方式 | 線形補間（Lerp） |
| 補間係数 | 0.1（スムーズさ調整用） |
| 帯域削減 | 静止時は同期頻度を下げる（5 tick/秒） |

#### 4.3.3 プレイヤー情報同期

| 項目 | 仕様 |
|------|------|
| ID | FN-006 |
| 同期データ | PlayerName (string, 10文字以内) |
| 同期タイミング | スポーン時、変更時 |
| データサイズ | 最大20バイト |

### 4.4 犬の追従機能

#### 4.4.1 基本追従

| 項目 | 仕様 |
|------|------|
| ID | FN-007 |
| 機能名 | 犬の追従AI |
| 追従距離 | プレイヤーの後方1.5m |
| 追従速度 | プレイヤー移動速度の1.2倍（追いつき用） |
| 最小距離 | 1.0m（これより近づかない） |
| 最大距離 | 5.0m（これ以上離れたらテレポート） |

#### 4.4.2 追従ロジック

```csharp
// 犬の追従ロジック
void UpdateDogPosition()
{
    Vector3 targetPos = player.position - player.forward * followDistance;
    float distance = Vector3.Distance(dog.position, player.position);
    
    if (distance > maxDistance)
    {
        // テレポート（ワープ）
        dog.position = targetPos;
    }
    else if (distance > minDistance)
    {
        // 追従移動
        dog.position = Vector3.MoveTowards(
            dog.position, 
            targetPos, 
            followSpeed * Time.deltaTime
        );
    }
    
    // プレイヤーの方を向く
    dog.LookAt(player.position);
}
```

#### 4.4.3 犬のアニメーション

| 状態 | アニメーション | 遷移条件 |
|------|--------------|---------|
| Idle | 立って尻尾を振る | 移動速度 < 0.1 |
| Walk | 歩く | 0.1 ≤ 移動速度 < 3.0 |
| Run | 走る | 移動速度 ≥ 3.0 |
| Sit | 座る | プレイヤーが5秒以上静止 |

### 4.5 移動機能

#### 4.5.1 プレイヤー移動

| 項目 | 仕様 |
|------|------|
| ID | FN-008 |
| 入力方式 | バーチャルジョイスティック |
| 移動速度 | 5.0 m/秒 |
| 加速度 | 即時（加速カーブなし） |
| 減速 | 即時停止 |
| 移動方向 | ジョイスティック方向 = 移動方向 |
| 向き | 移動方向を向く |

#### 4.5.2 カメラ

| 項目 | 仕様 |
|------|------|
| 視点 | アイソメトリック（俯瞰） |
| カメラ角度 | X: 45°, Y: 45° |
| 投影 | Orthographic |
| Orthographic Size | 8 |
| 追従対象 | ローカルプレイヤー |
| 追従速度 | Lerp係数 0.1 |
| 境界 | マップ端でカメラ停止 |

### 4.6 散歩終了機能

#### 4.6.1 正常終了

| 項目 | 仕様 |
|------|------|
| ID | FN-009 |
| トリガー | 「散歩やめる」ボタン → 確認「はい」 |
| 処理順序 | 1. 確認ダイアログ → 2. フェードアウト → 3. ルーム退出 → 4. シーン遷移 |
| フェード時間 | 1.0秒 |

#### 4.6.2 異常終了

| 状況 | 処理 |
|------|------|
| ネットワーク切断 | 自動再接続を3回試行、失敗時はメインシーンへ |
| アプリバックグラウンド | 30秒以内なら復帰可能、超過時は退出扱い |
| 強制終了 | 次回起動時はメインシーンから |

---

## 5. ネットワーク仕様

### 5.1 Photon Fusion設定

#### 5.1.1 基本設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| Topology | Shared Mode | サーバー権威、ホスト不要 |
| Tick Rate | 30 | 1秒間のシミュレーション回数 |
| Input Authority | 各プレイヤー | 自分の入力のみ権限を持つ |
| State Authority | サーバー | 状態はサーバーで管理 |

#### 5.1.2 同期オブジェクト

| オブジェクト | 同期データ | 同期方式 |
|------------|-----------|---------|
| Player | Position, Rotation, Name | NetworkTransform + Networked変数 |
| Dog | Position, Rotation | NetworkTransform |
| Voice | なし（Voice 2が管理） | - |

### 5.2 通信プロトコル

| 用途 | プロトコル | ポート |
|------|-----------|--------|
| ゲーム同期 | UDP (Reliable/Unreliable) | 5058 |
| 音声通話 | UDP | 5055 |
| 認証・マッチング | WebSocket | 443 |

### 5.3 帯域使用量

| 項目 | 予想帯域 |
|------|---------|
| 位置同期（1プレイヤー） | 約2 KB/秒 |
| 音声送信 | 約8 KB/秒（Opus 64kbps） |
| 音声受信（9人分最大） | 約72 KB/秒 |
| **合計（最大）** | **約82 KB/秒** |

---

## 6. 音声通話仕様

### 6.1 Photon Voice 2設定

#### 6.1.1 基本設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| コーデック | Opus | 低帯域高品質 |
| サンプリングレート | 24000 Hz | 音声品質 |
| フレームサイズ | 20ms | 遅延とのバランス |
| ビットレート | 64 kbps | 帯域と品質のバランス |
| チャンネル | Mono | 帯域節約 |

#### 6.1.2 録音設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| 音声検出 | VAD（Voice Activity Detection） | 話している時のみ送信 |
| VAD閾値 | 0.01 | 感度（高齢者の小声にも対応） |
| 送信間隔 | 即時 | リアルタイム性重視 |

### 6.2 近接音声（Proximity Voice）

#### 6.2.1 距離による音量変化

| 距離 | 音量 | 説明 |
|------|------|------|
| 0 - 2m | 100% | フル音量 |
| 2 - 10m | 100% → 0%（線形減衰） | 距離に応じて減衰 |
| 10m以上 | 0% | 聞こえない |

```csharp
// 音量計算式
float CalculateVolume(float distance)
{
    const float minDistance = 2f;
    const float maxDistance = 10f;
    
    if (distance <= minDistance) return 1f;
    if (distance >= maxDistance) return 0f;
    
    return 1f - (distance - minDistance) / (maxDistance - minDistance);
}
```

#### 6.2.2 3D音響設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| Spatial Blend | 1.0 | 完全3D |
| Doppler Level | 0 | ドップラー効果なし |
| Spread | 0 | 点音源 |
| Rolloff Mode | Linear | 線形減衰 |

### 6.3 ミュート機能

| 項目 | 仕様 |
|------|------|
| 対象 | 自分のマイク送信のみ |
| デフォルト | ミュート解除（ON） |
| 状態保存 | アプリ終了時まで保持 |
| 他者通知 | なし（自分だけの操作） |

---

## 7. データ構造

### 7.1 ネットワーク入力データ

```csharp
public struct NetworkInputData : INetworkInput
{
    /// <summary>
    /// 移動方向（正規化済み）
    /// </summary>
    public Vector2 MoveDirection;
    
    /// <summary>
    /// 入力があるかどうか
    /// </summary>
    public bool HasInput => MoveDirection.sqrMagnitude > 0.01f;
}
```

### 7.2 プレイヤーデータ

```csharp
public class PlayerData : NetworkBehaviour
{
    /// <summary>
    /// プレイヤー表示名（最大10文字）
    /// </summary>
    [Networked, Capacity(10)]
    public string DisplayName { get; set; }
    
    /// <summary>
    /// ミュート状態
    /// </summary>
    [Networked]
    public bool IsMuted { get; set; }
    
    /// <summary>
    /// 参加時刻（サーバー時刻）
    /// </summary>
    [Networked]
    public int JoinedTick { get; set; }
}
```

### 7.3 ルームプロパティ

```csharp
public static class RoomProperties
{
    /// <summary>
    /// ルーム作成時刻（Unix時刻）
    /// </summary>
    public const string CREATED_AT = "createdAt";
    
    /// <summary>
    /// マップID（将来の拡張用）
    /// </summary>
    public const string MAP_ID = "mapId";
}
```

### 7.4 ローカル保存データ

```csharp
[Serializable]
public class WalkSettings
{
    /// <summary>
    /// ミュート設定の記憶
    /// </summary>
    public bool RememberMuteState;
    public bool LastMuteState;
    
    /// <summary>
    /// ジョイスティック感度（0.5〜1.5）
    /// </summary>
    public float JoystickSensitivity = 1.0f;
    
    /// <summary>
    /// 音量マスター（0〜1）
    /// </summary>
    public float MasterVolume = 1.0f;
}
```

---

## 8. シーケンス図

### 8.1 散歩開始シーケンス

```
ユーザー          TappuMain        NetworkManager      Photon Cloud       MetaverseScene
   │                 │                  │                  │                  │
   │ 「散歩に行く」   │                  │                  │                  │
   │────────────────>│                  │                  │                  │
   │                 │                  │                  │                  │
   │                 │ JoinWalkRoom()   │                  │                  │
   │                 │─────────────────>│                  │                  │
   │                 │                  │                  │                  │
   │                 │  ローディング表示 │                  │                  │
   │<────────────────│                  │                  │                  │
   │                 │                  │                  │                  │
   │                 │                  │ FindRoom()       │                  │
   │                 │                  │─────────────────>│                  │
   │                 │                  │                  │                  │
   │                 │                  │   RoomList       │                  │
   │                 │                  │<─────────────────│                  │
   │                 │                  │                  │                  │
   │                 │                  │ JoinRoom()       │                  │
   │                 │                  │─────────────────>│                  │
   │                 │                  │                  │                  │
   │                 │                  │   JoinSuccess    │                  │
   │                 │                  │<─────────────────│                  │
   │                 │                  │                  │                  │
   │                 │ OnConnected()    │                  │                  │
   │                 │<─────────────────│                  │                  │
   │                 │                  │                  │                  │
   │                 │ LoadScene()      │                  │                  │
   │                 │─────────────────────────────────────────────────────>│
   │                 │                  │                  │                  │
   │                 │                  │                  │   SceneLoaded   │
   │                 │<─────────────────────────────────────────────────────│
   │                 │                  │                  │                  │
   │                 │                  │ SpawnPlayer()    │                  │
   │                 │                  │─────────────────>│                  │
   │                 │                  │                  │                  │
   │  散歩開始！     │                  │                  │                  │
   │<────────────────│                  │                  │                  │
```

### 8.2 音声通話シーケンス

```
PlayerA           VoiceManager      Photon Voice       PlayerB
   │                   │                 │                │
   │ マイク入力        │                 │                │
   │──────────────────>│                 │                │
   │                   │                 │                │
   │                   │ VAD判定：話し中  │                │
   │                   │─────────────────>│                │
   │                   │                 │                │
   │                   │   音声パケット   │                │
   │                   │─────────────────>│                │
   │                   │                 │                │
   │                   │                 │ 距離計算       │
   │                   │                 │───────────────>│
   │                   │                 │                │
   │                   │                 │ 音量: 0.7      │
   │                   │                 │<───────────────│
   │                   │                 │                │
   │                   │                 │ 音声再生       │
   │                   │                 │───────────────>│
   │                   │                 │                │
```

### 8.3 散歩終了シーケンス

```
ユーザー          MetaverseHUD      NetworkManager      Photon Cloud       TappuMain
   │                 │                  │                  │                │
   │ 「散歩やめる」  │                  │                  │                │
   │────────────────>│                  │                  │                │
   │                 │                  │                  │                │
   │  確認ダイアログ │                  │                  │                │
   │<────────────────│                  │                  │                │
   │                 │                  │                  │                │
   │ 「はい」        │                  │                  │                │
   │────────────────>│                  │                  │                │
   │                 │                  │                  │                │
   │                 │ LeaveRoom()      │                  │                │
   │                 │─────────────────>│                  │                │
   │                 │                  │                  │                │
   │                 │                  │ Disconnect()     │                │
   │                 │                  │─────────────────>│                │
   │                 │                  │                  │                │
   │                 │                  │   DisconnectAck  │                │
   │                 │                  │<─────────────────│                │
   │                 │                  │                  │                │
   │                 │ OnDisconnected() │                  │                │
   │                 │<─────────────────│                  │                │
   │                 │                  │                  │                │
   │                 │ LoadScene()      │                  │                │
   │                 │─────────────────────────────────────────────────────>│
   │                 │                  │                  │                │
   │  メイン画面     │                  │                  │                │
   │<────────────────────────────────────────────────────────────────────────│
```

---

## 9. エラーハンドリング

### 9.1 エラー一覧

| エラーコード | 状況 | ユーザー表示 | 対処 |
|-------------|------|-------------|------|
| E001 | ネットワーク未接続 | 「インターネットに接続してください」 | 接続待機画面を表示 |
| E002 | ルーム検索タイムアウト | 「接続できませんでした。もう一度お試しください」 | リトライボタン表示 |
| E003 | ルーム満員 | 「混み合っています。しばらくお待ちください」 | 自動で別ルーム検索 |
| E004 | 接続中に切断 | 「接続が切れました。再接続しています...」 | 自動再接続（3回） |
| E005 | マイク権限なし | 「マイクの使用を許可してください」 | 設定画面へ誘導 |
| E006 | Photonサーバーエラー | 「サーバーに接続できません」 | メンテナンス案内 |

### 9.2 再接続ロジック

```csharp
async Task HandleDisconnection()
{
    const int maxRetries = 3;
    const int retryIntervalMs = 2000;
    
    for (int i = 0; i < maxRetries; i++)
    {
        ShowReconnectingUI(i + 1, maxRetries);
        
        await Task.Delay(retryIntervalMs);
        
        var result = await TryReconnect();
        if (result.Success)
        {
            HideReconnectingUI();
            return;
        }
    }
    
    // 3回失敗したらメインシーンへ
    ShowErrorDialog("接続できませんでした");
    ReturnToMainScene();
}
```

### 9.3 エラーダイアログUI

| 項目 | 仕様 |
|------|------|
| 背景 | 半透明黒オーバーレイ |
| ダイアログサイズ | 300 x 200 px |
| メッセージ | 中央揃え、24px |
| ボタン | 「OK」または「もう一度」「戻る」 |

---

## 10. セキュリティ

### 10.1 通信セキュリティ

| 項目 | 対策 |
|------|------|
| 通信暗号化 | Photonの標準暗号化（TLS相当） |
| 認証 | Photon App IDによる認証 |
| なりすまし | PlayerRefによる一意識別 |

### 10.2 不正行為対策

| リスク | 対策 |
|-------|------|
| 位置偽装 | サーバー権威モード（クライアントは入力のみ） |
| 速度チート | サーバー側で移動速度を検証 |
| 音声スパム | ミュート機能、将来的にブロック機能 |

### 10.3 プライバシー

| 項目 | 対策 |
|------|------|
| 個人情報 | 表示名のみ、本名不要 |
| 音声データ | リアルタイム処理のみ、録音なし |
| 位置データ | セッション終了時に破棄 |

---

## 11. パフォーマンス要件

### 11.1 フレームレート

| 項目 | 目標値 |
|------|--------|
| 最小FPS | 30 fps |
| 目標FPS | 60 fps |
| 許容ドロップ | 連続5フレーム以下 |

### 11.2 レイテンシ

| 項目 | 目標値 |
|------|--------|
| 入力遅延 | 100ms以下 |
| 音声遅延 | 200ms以下 |
| 位置同期遅延 | 150ms以下 |

### 11.3 メモリ使用量

| 項目 | 目標値 |
|------|--------|
| 追加メモリ | 100MB以下 |
| テクスチャ | 圧縮形式使用（ASTC） |
| AudioClip | ストリーミング再生 |

### 11.4 バッテリー消費

| 項目 | 対策 |
|------|------|
| ネットワーク | 静止時は同期頻度を下げる |
| GPS | 使用しない |
| 画面 | 自動輝度調整に任せる |

---

## 12. 高齢者向けUX設計

### 12.1 視認性

| 項目 | 仕様 |
|------|------|
| 最小フォントサイズ | 20px |
| 推奨フォントサイズ | 24-32px |
| コントラスト比 | 4.5:1以上（WCAG AA準拠） |
| ボタンサイズ | 最小 60x60px |
| タップ領域 | ボタン周囲に16pxの余白 |

### 12.2 操作性

| 項目 | 対策 |
|------|------|
| ダブルタップ | 不要（シングルタップのみ） |
| スワイプ | 不要（ジョイスティックのみ） |
| ピンチ | 不要（固定ズーム） |
| 長押し | 不要 |
| 誤タップ防止 | 重要操作は確認ダイアログ |

### 12.3 聴覚サポート

| 項目 | 仕様 |
|------|------|
| 音量デフォルト | 80%（少し大きめ） |
| 音声の明瞭度 | 中高音を強調するEQ設定 |
| 視覚フィードバック | 話している人のアイコンを表示 |

### 12.4 認知負荷軽減

| 項目 | 対策 |
|------|------|
| 選択肢 | 最小限（散歩開始/終了/ミュート） |
| 設定項目 | 初回は全てデフォルト |
| エラーメッセージ | 平易な日本語、専門用語なし |
| アニメーション | ゆっくり、派手すぎない |

---

## 13. テスト要件

### 13.1 単体テスト

| 対象 | テスト項目 |
|------|-----------|
| NetworkManager | ルーム接続/切断、再接続 |
| PlayerController | 移動、同期、スポーン |
| DogController | 追従、アニメーション遷移 |
| VoiceManager | ミュート、音量計算 |
| WalkScheduler | 時間判定 |

### 13.2 結合テスト

| シナリオ | 確認項目 |
|---------|---------|
| 2人接続 | 相互に見える、動きが同期 |
| 10人接続 | パフォーマンス低下なし |
| 入退室 | 他プレイヤーに通知される |
| 音声通話 | 近づくと聞こえる |
| シーン遷移 | メイン↔メタバース往復 |

### 13.3 ネットワークテスト

| 条件 | 確認項目 |
|------|---------|
| Wi-Fi環境 | 正常動作 |
| 4G環境 | 動作確認、遅延許容範囲内 |
| 低速回線（1Mbps） | 音声品質低下の程度 |
| パケットロス5% | 動作継続、リカバリ |
| 切断→再接続 | 正常復帰 |

### 13.4 デバイステスト

| デバイス | 確認項目 |
|---------|---------|
| 低スペック（3GB RAM） | FPS 30以上維持 |
| 中スペック（6GB RAM） | FPS 60維持 |
| 各種画面サイズ | UIレイアウト崩れなし |

### 13.5 受け入れテスト

| シナリオ | 手順 | 期待結果 |
|---------|------|---------|
| 基本フロー | 10時にアプリ起動→散歩→終了 | 正常完了 |
| 会話テスト | 2人で近づいて話す | 音声が聞こえる |
| 長時間テスト | 30分間散歩継続 | 問題なし |

---

## 14. 将来の拡張性

### 14.1 Phase 2候補機能

| 機能 | 概要 | 優先度 |
|------|------|--------|
| 複数マップ | 公園、海辺、商店街など | 高 |
| 家族参加 | 家族が別端末から参加 | 高 |
| エモート | 手を振る、お辞儀など | 中 |
| 散歩履歴 | 歩いた距離、会話回数の記録 | 中 |
| アバターカスタマイズ | 服装、帽子など | 低 |
| 季節イベント | 桜、紅葉など季節の演出 | 中 |

### 14.2 技術的拡張ポイント

| 項目 | 現在 | 拡張案 |
|------|------|--------|
| ルーム数 | 自動1種類 | 地域別、テーマ別 |
| マップ | 1種類固定 | 複数選択可能 |
| 犬の種類 | 1種類 | 複数犬種対応 |
| 時間帯 | 10時固定 | ユーザー設定可能 |

### 14.3 設計上の配慮

- NetworkManagerはシングルトンで拡張しやすい設計
- マップIDをルームプロパティに含めて複数マップ対応可能
- プレイヤーデータにアバター情報を追加できる構造

---

## 15. 用語集

| 用語 | 説明 |
|------|------|
| CCU | Concurrent Users（同時接続ユーザー数） |
| Photon Fusion | Unityのマルチプレイヤーネットワークライブラリ |
| Photon Voice | Photonの音声通話ライブラリ |
| Shared Mode | ホストを必要としないPhoton Fusionの動作モード |
| Tick | Fusionのシミュレーション単位（30tick/秒 = 約33ms） |
| Proximity Voice | 距離に応じて音量が変わる音声システム |
| VAD | Voice Activity Detection（音声検出） |
| Spawn | ネットワーク上にオブジェクトを生成すること |
| NetworkObject | Fusionで同期されるゲームオブジェクト |
| Networked変数 | ネットワーク上で自動同期される変数 |

---

## 改訂履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 1.0 | 2025/02 | 初版作成 |

---

## 付録

### A. 参考リンク

- [Photon Fusion ドキュメント](https://doc.photonengine.com/fusion/current/getting-started/fusion-intro)
- [Photon Voice ドキュメント](https://doc.photonengine.com/voice/current/getting-started/voice-intro)
- [Unity 公式ドキュメント](https://docs.unity3d.com/)

### B. 関連ドキュメント

- Tappu メタバース散歩機能 概要.md
- エンジニア募集 掲示板掲載内容.md
