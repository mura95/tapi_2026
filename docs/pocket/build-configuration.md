# ビルド分け実装方針（再検討版）

## 1. 概要

たっぷハウス（メインアプリ）とたっぷポケット（サブアプリ）のビルド分け方針を再検討した結果、**Define Symbolsによる完全分離は不要**という結論に至った。

---

## 2. 再検討の背景

### 2.1 当初の想定

```
┌─────────────────────────────────────────────────────────────┐
│                    当初の想定（見直し前）                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   たっぷハウス（TAPHOUSE_MAIN）                              │
│   └── フル機能（餌やり、遊び、おやつ、リマインダー等）       │
│                                                             │
│   たっぷポケット（TAPHOUSE_POCKET）                          │
│   └── コンパクト機能（コール、着せ替え、歩数計、脳トレ）     │
│                                                             │
│   → 完全に分離されたアプリ                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 実際の要件

```
┌─────────────────────────────────────────────────────────────┐
│                    実際の要件（見直し後）                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   たっぷポケットでコールして犬を呼ぶと...                   │
│                                                             │
│   ┌─────────────────────────────────────────────────┐      │
│   │   フル機能が使える！                             │      │
│   │   - 餌やり ✓                                     │      │
│   │   - おもちゃ遊び ✓                               │      │
│   │   - おやつ ✓                                     │      │
│   │   - なでる ✓                                     │      │
│   │   + 着せ替え（ポケット専用）                     │      │
│   │   + 歩数計（ポケット専用）                       │      │
│   │   + ミニゲーム（ポケット専用）                   │      │
│   └─────────────────────────────────────────────────┘      │
│                                                             │
│   → 機能で分けるのではなく、UIとエントリーポイントだけ違う  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 新しいアプローチ

### 3.1 結論

**Define Symbolsによる完全分離は不要。代わりにランタイム設定で切り替える。**

| 項目 | 方式 |
|------|------|
| コードベース | 共通 |
| 機能 | 共通（一部追加機能あり） |
| UI | エントリーポイントのみ異なる |
| 切り替え | ランタイム設定 or ビルド設定 |

### 3.2 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    新しいアーキテクチャ                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────┐      │
│   │               共通コードベース                   │      │
│   │  ┌──────────────────────────────────────────┐  │      │
│   │  │ 犬の状態管理、餌やり、遊び、おやつ等      │  │      │
│   │  │ Firebase連携、DogLocationSync             │  │      │
│   │  │ アニメーション、サウンド                   │  │      │
│   │  └──────────────────────────────────────────┘  │      │
│   └─────────────────────────────────────────────────┘      │
│                         ↑                                   │
│         ┌───────────────┼───────────────┐                  │
│         │               │               │                  │
│   ┌─────┴─────┐   ┌─────┴─────┐   ┌─────┴─────┐           │
│   │ メインUI   │   │ ポケットUI │   │ 追加機能  │           │
│   │（ハウス）  │   │（ポケット）│   │           │           │
│   │           │   │           │   │ - 着せ替え │           │
│   │餌/遊び/   │   │コール/    │   │ - 歩数計   │           │
│   │おやつボタン│   │ゲーム/    │   │ - ミニゲーム│          │
│   │           │   │歩数計ボタン│   │           │           │
│   └───────────┘   └───────────┘   └───────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 実装方式

### 4.1 AppMode によるランタイム切り替え

```csharp
public enum AppMode
{
    TapHouse,   // たっぷハウス（メイン画面から開始）
    TapPocket   // たっぷポケット（ポケット画面から開始）
}

public class AppConfig : MonoBehaviour
{
    public static AppConfig Instance { get; private set; }

    [Header("アプリモード")]
    [SerializeField] private AppMode appMode = AppMode.TapHouse;

    public AppMode Mode => appMode;

    // ポケット専用機能が有効か
    public bool IsPocketFeatureEnabled => true; // 常に有効（両アプリで使える）

    // 現在のエントリーポイント
    public string StartScene => appMode switch
    {
        AppMode.TapHouse => "main",
        AppMode.TapPocket => "PocketMain",
        _ => "main"
    };
}
```

### 4.2 ビルド時の設定

```csharp
// エディタスクリプト
public static class AppBuildHelper
{
    [MenuItem("Build/Build TapHouse")]
    public static void BuildTapHouse()
    {
        // AppConfigのappModeをTapHouseに設定
        SetAppMode(AppMode.TapHouse);

        // ビルド
        BuildPlayer("TapHouse.apk");
    }

    [MenuItem("Build/Build TapPocket")]
    public static void BuildTapPocket()
    {
        // AppConfigのappModeをTapPocketに設定
        SetAppMode(AppMode.TapPocket);

        // ビルド
        BuildPlayer("TapPocket.apk");
    }
}
```

---

## 5. 機能の分類

### 5.1 共通機能（両アプリで使用）

| 機能 | 説明 |
|------|------|
| 犬の表示・アニメーション | 基本の犬の動き |
| 餌やり | 犬に餌をあげる |
| おもちゃ遊び | ボール等で遊ぶ |
| おやつ | おやつをあげる |
| なでる | タッチで撫でる |
| Firebase同期 | 状態のクラウド同期 |
| DogLocationSync | デバイス間の犬の移動 |
| リマインダー | 通知機能 |

### 5.2 追加機能（両アプリで使用可能だが、ポケット向け）

| 機能 | 説明 | ポケット | ハウス |
|------|------|:--------:|:------:|
| 着せ替え | 犬の服装変更 | ○ | △（将来対応可） |
| 歩数計 | 歩数管理 | ○ | × |
| ミニゲーム | 犬と遊ぶゲーム | ○ | △（将来対応可） |
| 加速度歩行 | センサー連動歩行 | ○ | × |

### 5.3 UI/エントリーポイントの違い

| 項目 | たっぷハウス | たっぷポケット |
|------|-------------|---------------|
| 起動画面 | main.unity | PocketMain.unity |
| メインボタン | 餌/遊び/おやつ | コール/着替え/歩数計/ゲーム |
| 犬の初期位置 | 常にいる | コールで呼ぶ |
| 対象デバイス | タブレット | スマホ |

---

## 6. 画面遷移

### 6.1 ポケットの画面遷移

```
┌─────────────────────────────────────────────────────────────┐
│                    ポケットの画面遷移                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ポケットメイン画面                                        │
│   ├── コール → たっぷハウス画面（フル機能）                │
│   │            └── 餌やり、遊び、おやつ、なでる等         │
│   ├── 着せ替え → 着せ替え画面                              │
│   ├── 歩数計 → 歩数計画面                                  │
│   ├── ミニゲーム → ゲーム選択画面                          │
│   └── メタバース → メタバース画面                          │
│                                                             │
│   「コール」で犬を呼ぶと、ハウス画面でフル機能が使える！   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 共通のたっぷハウス画面

コールで犬を呼んだ後は、たっぷハウスと同じ画面・機能を使用：

```csharp
// コールボタンが押された時
public async void OnCallButtonPressed()
{
    await DogLocationSync.Instance.RequestCallDog();

    // 犬が来たら、たっぷハウス画面に遷移
    DogLocationSync.Instance.OnDogPresenceChanged += (hasDog) =>
    {
        if (hasDog)
        {
            SceneManager.LoadScene("main"); // 共通のたっぷハウス画面
        }
    };
}
```

---

## 7. シーン構成

### 7.1 シーン一覧

```
Assets/Scenes/
├── Common/
│   ├── Splash.unity           # スプラッシュ（共通）
│   └── Login.unity            # ログイン（共通）
├── main.unity                 # たっぷハウス画面（共通）
├── Pocket/
│   ├── PocketMain.unity       # ポケットメイン画面
│   ├── DressUp.unity          # 着せ替え
│   ├── Pedometer.unity        # 歩数計
│   └── MiniGames.unity        # ミニゲーム
└── Metaverse/
    └── Metaverse.unity        # メタバース（共通）
```

### 7.2 ビルド設定

```csharp
// TapHouseビルド
EditorBuildSettings.scenes = new[] {
    "Splash", "Login", "main", "Metaverse",
    "DressUp", "Pedometer", "MiniGames"  // ポケット機能も含む
};

// TapPocketビルド
EditorBuildSettings.scenes = new[] {
    "Splash", "Login", "PocketMain", "main", "Metaverse",
    "DressUp", "Pedometer", "MiniGames"
};
```

---

## 8. 利点

### 8.1 新方式の利点

| 利点 | 説明 |
|------|------|
| コード重複なし | 同じ機能を2回実装する必要なし |
| メンテナンス容易 | 1箇所の修正で両アプリに反映 |
| 機能追加が簡単 | 新機能を両アプリで使える |
| テスト効率化 | 共通部分は1回のテストでOK |

### 8.2 Define Symbols方式の問題点

| 問題点 | 説明 |
|--------|------|
| コード重複 | 同じ機能を2箇所で実装する可能性 |
| 条件分岐の複雑化 | #if が増えて可読性低下 |
| ビルドエラーリスク | 片方のビルドでしか発見されないバグ |
| 機能追加の手間 | 両方のシンボルで動作確認が必要 |

---

## 9. 実装チェックリスト

### 9.1 共通化の確認

- [ ] 餌やり機能は共通コードか
- [ ] 遊び機能は共通コードか
- [ ] おやつ機能は共通コードか
- [ ] Firebase連携は共通コードか
- [ ] DogLocationSyncは共通コードか

### 9.2 UI分離の確認

- [ ] ポケットメイン画面は専用か
- [ ] エントリーポイントの切り替えができるか
- [ ] ボタン配置がアプリごとに適切か

---

## 10. 移行計画

### 10.1 既存コードの整理

1. `#if TAPHOUSE_MAIN` / `#if TAPHOUSE_POCKET` の条件分岐を削除
2. 共通コードとして統合
3. UIのみ分離

### 10.2 新規実装

1. `AppConfig` クラスの実装
2. ポケットメイン画面の実装
3. ビルドスクリプトの更新

---

## 11. 関連ドキュメント

| ドキュメント | 説明 |
|-------------|------|
| [platform/build-settings.md](./platform/build-settings.md) | プラットフォーム別ビルド設定 |
| [pocket-overview.md](./pocket-overview.md) | たっぷポケット全体概要 |
| [ui-architecture.md](./ui-architecture.md) | UI設計 |
